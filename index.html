<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADRIA GOLD - Objednávky</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; }
        .admin-tab-content { display: none; }
        .admin-tab-content.active { display: block; }
        .tab-button.active { background-color: #4A5568; color: white; }
        .product-card {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 100%;
        }
        .product-card .price {
            font-size: 1.25rem; /* text-xl */
            font-weight: bold;
            color: #2F855A; /* green-700 */
        }
        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { position: absolute; left: 0; top: 0; width: 100%; }
            .no-print { display: none; }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-900">

    <div class="fixed top-4 right-4 z-50">
        <button id="adminLoginButton" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded shadow">
            Admin Login
        </button>
    </div>

    <div id="adminPanelOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-40">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-2xl">
            <h2 class="text-2xl font-bold mb-6 text-center">Admin Panel</h2>

            <div class="flex border-b border-gray-300 mb-4">
                <button class="tab-button py-2 px-4 text-gray-700 hover:text-gray-900 active" onclick="showAdminTab('ordersTab')">Objednávky</button>
                <button class="tab-button py-2 px-4 text-gray-700 hover:text-gray-900" onclick="showAdminTab('productsTab')">Produkty</button>
                <button class="tab-button py-2 px-4 text-gray-700 hover:text-gray-900" onclick="showAdminTab('usersTab')">Uživatelé</button>
                <button class="tab-button py-2 px-4 text-gray-700 hover:text-gray-900" onclick="showAdminTab('settingsTab')">Nastavení</button>
                <button class="tab-button py-2 px-4 text-gray-700 hover:text-gray-900" onclick="showAdminTab('billingTab')">Vyúčtování</button>
            </div>

            <div id="ordersTab" class="admin-tab-content active">
                <h3 class="text-xl font-semibold mb-4">Objednávky</h3>
                <input type="text" id="orderSearch" onkeyup="filterOrders()" placeholder="Hledat uživatele..." class="mb-4 p-2 border rounded w-full">
                <div id="ordersList" class="max-h-96 overflow-y-auto border rounded p-2"></div>
                <button onclick="printOrderSummary()" class="mt-4 bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700 no-print">
                    Tisk přehledu
                </button>
                <button onclick="exportOrdersToCsv()" class="mt-4 bg-orange-600 text-white px-4 py-2 rounded hover:bg-orange-700 no-print">
                    Export do CSV
                </button>
            </div>

            <div id="productsTab" class="admin-tab-content">
                <h3 class="text-xl font-semibold mb-4">Produkty</h3>
                <input type="file" id="pdfUpload" accept=".pdf" class="mb-4">
                <button onclick="uploadPdf()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Nahrát PDF</button>
                <div id="pdfStatus" class="mt-2 text-sm text-gray-700"></div>
                <div id="productsList" class="max-h-96 overflow-y-auto border rounded p-2 mt-4"></div>
            </div>

            <div id="usersTab" class="admin-tab-content">
                <h3 class="text-xl font-semibold mb-4">Uživatelé</h3>
                <input type="text" id="userSearch" onkeyup="filterUsers()" placeholder="Hledat uživatele..." class="mb-4 p-2 border rounded w-full">
                <div id="usersList" class="max-h-96 overflow-y-auto border rounded p-2"></div>
            </div>

            <div id="settingsTab" class="admin-tab-content">
                <h3 class="text-xl font-semibold mb-4">Nastavení</h3>
                <div class="mb-4">
                    <label for="orderDeadline" class="block text-sm font-medium text-gray-700">Příjem objednávek do:</label>
                    <input type="datetime-local" id="orderDeadline" class="mt-1 p-2 border rounded w-full">
                    <button onclick="saveOrderDeadline()" class="mt-2 bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Uložit termín</button>
                    <p id="deadlineStatus" class="mt-2 text-sm text-gray-700"></p>
                </div>
                <div class="mb-4">
                    <label for="adminPassword" class="block text-sm font-medium text-gray-700">Změnit admin heslo:</label>
                    <input type="password" id="adminPassword" class="mt-1 p-2 border rounded w-full" placeholder="Nové heslo">
                    <button onclick="changeAdminPassword()" class="mt-2 bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Změnit heslo</button>
                    <p id="passwordChangeStatus" class="mt-2 text-sm text-gray-700"></p>
                </div>
            </div>

            <div id="billingTab" class="admin-tab-content">
                <h3 class="text-xl font-semibold mb-4">Vyúčtování</h3>
                <div id="billingList"></div>
                <button onclick="sendAllBillingEmails()" class="mt-4 bg-green-700 text-white px-4 py-2 rounded hover:bg-green-800">
                    Odeslat vyúčtování všem
                </button>
                <div id="sendEmailStatus" class="mt-2 text-sm text-gray-700"></div>
            </div>

            <button onclick="closeAdminPanel()" class="mt-6 bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded shadow">
                Zavřít
            </button>
        </div>
    </div>

    <div class="container mx-auto p-4">
        <h1 class="text-3xl font-bold text-center mb-6">ADRIA GOLD - Objednávky</h1>

        <div id="userInfo" class="bg-white p-6 rounded-lg shadow-md mb-6">
            <h2 class="text-2xl font-semibold mb-4">Vaše objednávka</h2>
            <div class="mb-4">
                <label for="userName" class="block text-sm font-medium text-gray-700">Jméno:</label>
                <input type="text" id="userName" placeholder="Zadejte své jméno" class="mt-1 p-2 border rounded w-full">
            </div>
            <div class="mb-4">
                <label for="userEmail" class="block text-sm font-medium text-gray-700">E-mail:</label>
                <input type="email" id="userEmail" placeholder="Zadejte svůj e-mail" class="mt-1 p-2 border rounded w-full">
            </div>
            <div class="mb-4">
                <label for="userPhone" class="block text-sm font-medium text-gray-700">Telefon (nepovinné):</label>
                <input type="tel" id="userPhone" placeholder="Zadejte své telefonní číslo" class="mt-1 p-2 border rounded w-full">
            </div>
            <button onclick="saveUserInfo()" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded shadow">
                Uložit údaje
            </button>
        </div>

        <div id="orderSummary" class="bg-white p-6 rounded-lg shadow-md mb-6">
            <h2 class="text-2xl font-semibold mb-4">Souhrn objednávky</h2>
            <div id="orderItems" class="mb-4">
                <p class="text-gray-600">Zatím nemáte žádné položky v objednávce.</p>
            </div>
            <div class="flex justify-between items-center border-t pt-4">
                <span class="text-xl font-bold">Celkem:</span>
                <span id="orderTotal" class="text-xl font-bold">0 Kč</span>
            </div>
            <button onclick="placeOrder()" class="mt-4 bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded shadow w-full">
                Odeslat objednávku
            </button>
            <div id="orderStatus" class="mt-2 text-center text-sm text-gray-700"></div>
        </div>

        <div class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-2xl font-semibold mb-4">Produkty</h2>
            <div id="productsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-functions.js"></script>

    <script>
        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY", // NAHRAĎTE SVÝM API KLÍČEM
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com", // NAHRAĎTE SVÝM PROJECT ID
            projectId: "YOUR_PROJECT_ID", // NAHRAĎTE SVÝM PROJECT ID
            storageBucket: "YOUR_PROJECT_ID.appspot.com", // NAHRAĎTE SVÝM PROJECT ID
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID", // NAHRAĎTE SVÝM MESSAGING SENDER ID
            appId: "YOUR_APP_ID" // NAHRAĎTE SVÝM APP ID
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const storage = firebase.storage();

        // Initialize Firebase Functions SDK
        const functions = firebase.functions();
        // Pokud vyvíjíte lokálně s Firebase emulátorem, odkomentujte následující řádek:
        // if (location.hostname === "localhost") {
        //     functions.useEmulator("http://localhost:5001");
        // }

        // Global variables
        let currentUser = null;
        let products = [];
        let order = {};
        let orderDeadline = null;
        const ADMIN_PASSWORD_KEY = 'admin_password'; // Klíč pro uložení hesla v localStorage

        // --- Utility Functions ---
        function formatPrice(price) {
            return `${price} Kč`;
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `fixed bottom-4 right-4 p-4 rounded-lg shadow-lg text-white ${
                type === 'success' ? 'bg-green-500' :
                type === 'error' ? 'bg-red-500' :
                'bg-gray-700'
            }`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // --- User Info and Order Management ---
        async function loadUserInfo() {
            const storedUser = JSON.parse(localStorage.getItem('adriaUser'));
            if (storedUser) {
                document.getElementById('userName').value = storedUser.name || '';
                document.getElementById('userEmail').value = storedUser.email || '';
                document.getElementById('userPhone').value = storedUser.phone || '';
                currentUser = storedUser;
                await loadUserOrder(currentUser.id);
            } else {
                currentUser = { id: db.collection('users').doc().id }; // Generate a new ID for new user
            }
        }

        async function saveUserInfo() {
            const name = document.getElementById('userName').value.trim();
            const email = document.getElementById('userEmail').value.trim();
            const phone = document.getElementById('userPhone').value.trim();

            if (!name || !email) {
                alert('Jméno a e-mail jsou povinné!');
                return;
            }

            currentUser.name = name;
            currentUser.email = email;
            currentUser.phone = phone;

            try {
                await db.collection('users').doc(currentUser.id).set(currentUser, { merge: true });
                localStorage.setItem('adriaUser', JSON.stringify(currentUser));
                showToast('Uživatelské údaje uloženy!', 'success');
            } catch (error) {
                console.error("Chyba při ukládání uživatelských údajů:", error);
                showToast('Chyba při ukládání údajů.', 'error');
            }
        }

        async function loadUserOrder(userId) {
            const orderDoc = await db.collection('orders').doc(userId).get();
            if (orderDoc.exists) {
                order = orderDoc.data().items || {};
            } else {
                order = {};
            }
            updateOrderSummary();
        }

        function updateOrderSummary() {
            const orderItemsDiv = document.getElementById('orderItems');
            const orderTotalSpan = document.getElementById('orderTotal');
            let total = 0;
            let html = '';

            if (Object.keys(order).length === 0) {
                orderItemsDiv.innerHTML = '<p class="text-gray-600">Zatím nemáte žádné položky v objednávce.</p>';
            } else {
                html += '<ul class="list-disc pl-5">';
                for (const productId in order) {
                    const quantity = order[productId];
                    const product = products.find(p => p.id === productId);
                    if (product) {
                        const itemTotal = product.price * quantity;
                        total += itemTotal;
                        html += `
                            <li class="flex justify-between items-center mb-2">
                                <span>${product.name} (${formatPrice(product.price)}) x ${quantity}</span>
                                <div class="flex items-center">
                                    <span class="font-semibold mr-2">${formatPrice(itemTotal)}</span>
                                    <button onclick="updateQuantity('${productId}', -1)" class="bg-red-400 text-white px-2 py-1 rounded-full text-xs hover:bg-red-500">-</button>
                                    <button onclick="updateQuantity('${productId}', 1)" class="bg-green-400 text-white px-2 py-1 rounded-full text-xs ml-1 hover:bg-green-500">+</button>
                                    <button onclick="removeFromOrder('${productId}')" class="bg-gray-400 text-white px-2 py-1 rounded-full text-xs ml-1 hover:bg-gray-500">X</button>
                                </div>
                            </li>
                        `;
                    }
                }
                html += '</ul>';
                orderItemsDiv.innerHTML = html;
            }
            orderTotalSpan.textContent = formatPrice(total);
        }

        async function addToOrder(productId) {
            if (!currentUser || !currentUser.id) {
                alert('Prosím, nejprve uložte své jméno a e-mail.');
                return;
            }

            const now = new Date();
            if (orderDeadline && now > orderDeadline) {
                alert('Příjem objednávek je již uzavřen.');
                return;
            }

            order[productId] = (order[productId] || 0) + 1;
            updateOrderSummary();
            showToast('Produkt přidán do objednávky!', 'success');
        }

        function updateQuantity(productId, change) {
            order[productId] = (order[productId] || 0) + change;
            if (order[productId] <= 0) {
                delete order[productId];
            }
            updateOrderSummary();
        }

        function removeFromOrder(productId) {
            if (confirm('Opravdu chcete odebrat tento produkt z objednávky?')) {
                delete order[productId];
                updateOrderSummary();
                showToast('Produkt odebrán.', 'info');
            }
        }

        async function placeOrder() {
            if (!currentUser || !currentUser.id) {
                alert('Prosím, nejprve uložte své jméno a e-mail.');
                return;
            }
            if (Object.keys(order).length === 0) {
                alert('Vaše objednávka je prázdná.');
                return;
            }

            const orderStatusDiv = document.getElementById('orderStatus');
            orderStatusDiv.textContent = 'Odesílám objednávku...';
            orderStatusDiv.className = 'mt-2 text-center text-blue-600';

            try {
                await db.collection('orders').doc(currentUser.id).set({
                    userId: currentUser.id,
                    userName: currentUser.name,
                    userEmail: currentUser.email,
                    userPhone: currentUser.phone,
                    items: order,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    status: 'active' // 'active', 'paid', 'cancelled'
                }, { merge: true });

                order = {}; // Clear local order
                updateOrderSummary();
                orderStatusDiv.textContent = 'Objednávka úspěšně odeslána!';
                orderStatusDiv.className = 'mt-2 text-center text-green-600';
                showToast('Objednávka odeslána!', 'success');
            } catch (error) {
                console.error("Chyba při odesílání objednávky:", error);
                orderStatusDiv.textContent = 'Chyba při odesílání objednávky.';
                orderStatusDiv.className = 'mt-2 text-center text-red-600';
                showToast('Chyba při odesílání objednávky.', 'error');
            }
        }

        // --- Product Display ---
        async function loadProducts() {
            try {
                const snapshot = await db.collection('products').orderBy('name').get();
                products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                displayProducts();
            } catch (error) {
                console.error("Chyba při načítání produktů:", error);
                showToast('Chyba při načítání produktů.', 'error');
            }
        }

        function displayProducts() {
            const productsGrid = document.getElementById('productsGrid');
            productsGrid.innerHTML = ''; // Clear existing products

            products.forEach(product => {
                const productCard = document.createElement('div');
                productCard.className = 'bg-gray-50 p-4 rounded-lg shadow-md flex flex-col justify-between product-card';
                productCard.innerHTML = `
                    <div>
                        <h3 class="text-lg font-semibold mb-2">${product.name}</h3>
                        <p class="text-gray-600 mb-2">${product.description || 'Popis není k dispozici.'}</p>
                    </div>
                    <div class="mt-4 flex justify-between items-center">
                        <span class="price">${formatPrice(product.price)}</span>
                        <button onclick="addToOrder('${product.id}')" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded shadow">
                            Přidat do košíku
                        </button>
                    </div>
                `;
                productsGrid.appendChild(productCard);
            });
        }

        // --- Admin Panel ---
        let isAdminLoggedIn = false;

        document.getElementById('adminLoginButton').addEventListener('click', () => {
            if (isAdminLoggedIn) {
                closeAdminPanel();
                isAdminLoggedIn = false;
                document.getElementById('adminLoginButton').textContent = 'Admin Login';
                showToast('Odhlášeno z admin panelu.', 'info');
            } else {
                const password = prompt('Zadejte admin heslo:');
                const storedPassword = localStorage.getItem(ADMIN_PASSWORD_KEY) || 'admin123'; // Default heslo
                if (password === storedPassword) {
                    isAdminLoggedIn = true;
                    document.getElementById('adminLoginButton').textContent = 'Admin Logout';
                    document.getElementById('adminPanelOverlay').classList.remove('hidden');
                    loadAdminData();
                    showToast('Přihlášeno do admin panelu.', 'success');
                } else {
                    alert('Nesprávné heslo!');
                    showToast('Nesprávné heslo!', 'error');
                }
            }
        });

        function closeAdminPanel() {
            document.getElementById('adminPanelOverlay').classList.add('hidden');
        }

        function showAdminTab(tabId) {
            document.querySelectorAll('.admin-tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            document.getElementById(tabId).classList.remove('hidden');

            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active', 'bg-gray-700', 'text-white');
                button.classList.add('text-gray-700', 'hover:text-gray-900');
            });
            event.currentTarget.classList.add('active', 'bg-gray-700', 'text-white');
            event.currentTarget.classList.remove('text-gray-700', 'hover:text-gray-900');

            if (tabId === 'ordersTab') {
                loadOrders();
            } else if (tabId === 'productsTab') {
                loadProductsAdmin();
            } else if (tabId === 'usersTab') {
                loadUsers();
            } else if (tabId === 'settingsTab') {
                loadOrderDeadline();
                loadAdminPasswordSetting();
            } else if (tabId === 'billingTab') {
                updateBilling();
            }
        }

        async function loadAdminData() {
            await loadOrders();
            await loadProductsAdmin();
            await loadUsers();
            await loadOrderDeadline();
            await updateBilling();
        }

        // --- Admin: Orders Tab ---
        let allOrders = [];
        async function loadOrders() {
            try {
                const snapshot = await db.collection('orders').orderBy('timestamp', 'desc').get();
                allOrders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                filterOrders(); // Display all initially
            } catch (error) {
                console.error("Chyba při načítání objednávek pro admina:", error);
                showToast('Chyba při načítání objednávek.', 'error');
            }
        }

        function filterOrders() {
            const searchTerm = document.getElementById('orderSearch').value.toLowerCase();
            const filtered = allOrders.filter(order =>
                order.userName.toLowerCase().includes(searchTerm) ||
                order.userEmail.toLowerCase().includes(searchTerm)
            );
            displayOrders(filtered);
        }

        function displayOrders(ordersToDisplay) {
            const ordersListDiv = document.getElementById('ordersList');
            ordersListDiv.innerHTML = '';
            if (ordersToDisplay.length === 0) {
                ordersListDiv.innerHTML = '<p class="text-gray-600">Žádné objednávky k zobrazení.</p>';
                return;
            }

            ordersToDisplay.forEach(order => {
                let itemsHtml = '';
                let orderTotal = 0;
                for (const productId in order.items) {
                    const quantity = order.items[productId];
                    const product = products.find(p => p.id === productId);
                    const productName = product ? product.name : `Neznámý produkt (ID: ${productId})`;
                    const itemPrice = product ? product.price : 0;
                    const itemTotal = itemPrice * quantity;
                    orderTotal += itemTotal;
                    itemsHtml += `<li class="text-sm">${productName} x ${quantity} (${formatPrice(itemTotal)})</li>`;
                }

                const orderElement = document.createElement('div');
                orderElement.className = 'bg-white p-4 rounded-lg shadow-md mb-4 border border-gray-200';
                orderElement.innerHTML = `
                    <h4 class="font-bold text-lg mb-2">${order.userName} (${order.userEmail})</h4>
                    <p class="text-sm text-gray-500 mb-2">Telefon: ${order.userPhone || 'Nezadáno'}</p>
                    <p class="text-sm text-gray-500 mb-2">Datum: ${order.timestamp ? new Date(order.timestamp.toDate()).toLocaleString() : 'N/A'}</p>
                    <p class="font-semibold mb-2">Položky:</p>
                    <ul class="list-disc pl-5 mb-2">${itemsHtml}</ul>
                    <p class="font-bold text-lg text-right">Celkem: ${formatPrice(orderTotal)}</p>
                    <div class="mt-2 flex justify-end space-x-2">
                        <button onclick="deleteOrder('${order.id}')" class="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600">Smazat</button>
                        <button onclick="showEmailPreview('${order.id}')" class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600">Náhled emailu</button>
                    </div>
                `;
                ordersListDiv.appendChild(orderElement);
            });
        }

        async function deleteOrder(orderId) {
            if (confirm('Opravdu chcete smazat tuto objednávku?')) {
                try {
                    await db.collection('orders').doc(orderId).delete();
                    showToast('Objednávka smazána!', 'success');
                    loadOrders(); // Reload orders after deletion
                } catch (error) {
                    console.error("Chyba při mazání objednávky:", error);
                    showToast('Chyba při mazání objednávky.', 'error');
                }
            }
        }

        async function printOrderSummary() {
            const printWindow = window.open('', '_blank');
            printWindow.document.write('<html><head><title>Přehled objednávek</title>');
            printWindow.document.write('<style>');
            printWindow.document.write(`
                body { font-family: Arial, sans-serif; margin: 20px; }
                table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
                th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                th { background-color: #f2f2f2; }
                .text-right { text-align: right; }
                .text-center { text-align: center; }
                h1, h2, h3 { margin-bottom: 10px; }
                .page-break { page-break-before: always; }
            `);
            printWindow.document.write('</style></head><body>');

            printWindow.document.write('<h1 class="text-2xl font-bold mb-4">Přehled objednávek ADRIA GOLD</h1>');

            // Souhrn produktů
            printWindow.document.write('<h2 class="text-xl font-semibold mb-2">Souhrn objednaných produktů</h2>');
            const productSummary = {};
            allOrders.forEach(order => {
                for (const productId in order.items) {
                    const quantity = order.items[productId];
                    productSummary[productId] = (productSummary[productId] || 0) + quantity;
                }
            });

            printWindow.document.write('<table><thead><tr><th>Produkt</th><th class="text-center">Celkem kusů</th></tr></thead><tbody>');
            for (const productId in productSummary) {
                const product = products.find(p => p.id === productId);
                const productName = product ? product.name : `Neznámý produkt (ID: ${productId})`;
                printWindow.document.write(`<tr><td>${productName}</td><td class="text-center">${productSummary[productId]}</td></tr>`);
            }
            printWindow.document.write('</tbody></table>');

            // Jednotlivé objednávky
            printWindow.document.write('<h2 class="text-xl font-semibold mb-2">Detailní objednávky</h2>');
            allOrders.forEach(order => {
                let itemsHtml = '';
                let orderTotal = 0;
                for (const productId in order.items) {
                    const quantity = order.items[productId];
                    const product = products.find(p => p.id === productId);
                    const productName = product ? product.name : `Neznámý produkt (ID: ${productId})`;
                    const itemPrice = product ? product.price : 0;
                    const itemTotal = itemPrice * quantity;
                    orderTotal += itemTotal;
                    itemsHtml += `<tr><td>${productName}</td><td class="text-center">${quantity}</td><td class="text-right">${formatPrice(itemPrice)}</td><td class="text-right">${formatPrice(itemTotal)}</td></tr>`;
                }

                printWindow.document.write(`
                    <div class="mb-6 page-break">
                        <h3 class="font-bold text-lg mb-1">${order.userName} (${order.userEmail})</h3>
                        <p class="text-sm text-gray-500 mb-1">Telefon: ${order.userPhone || 'Nezadáno'}</p>
                        <p class="text-sm text-gray-500 mb-2">Datum: ${order.timestamp ? new Date(order.timestamp.toDate()).toLocaleString() : 'N/A'}</p>
                        <table>
                            <thead>
                                <tr>
                                    <th>Produkt</th>
                                    <th class="text-center">Počet</th>
                                    <th class="text-right">Cena/ks</th>
                                    <th class="text-right">Celkem</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${itemsHtml}
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="3" class="text-right font-bold">Celkem:</td>
                                    <td class="text-right font-bold">${formatPrice(orderTotal)}</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                `);
            });

            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.print();
        }

        function exportOrdersToCsv() {
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Jméno,Email,Telefon,Datum Objednávky,Produkt,Množství,Cena/ks,Celkem Položky,Celkem Objednávky\n";

            allOrders.forEach(order => {
                let orderTotal = 0;
                for (const productId in order.items) {
                    const quantity = order.items[productId];
                    const product = products.find(p => p.id === productId);
                    const productName = product ? product.name : `Neznámý produkt (ID: ${productId})`;
                    const itemPrice = product ? product.price : 0;
                    const itemTotal = itemPrice * quantity;
                    orderTotal += itemTotal;
                }

                for (const productId in order.items) {
                    const quantity = order.items[productId];
                    const product = products.find(p => p.id === productId);
                    const productName = product ? product.name : `Neznámý produkt (ID: ${productId})`;
                    const itemPrice = product ? product.price : 0;
                    const itemTotal = itemPrice * quantity;

                    const row = [
                        `"${order.userName}"`,
                        `"${order.userEmail}"`,
                        `"${order.userPhone || ''}"`,
                        `"${order.timestamp ? new Date(order.timestamp.toDate()).toLocaleString() : ''}"`,
                        `"${productName}"`,
                        quantity,
                        itemPrice,
                        itemTotal,
                        orderTotal // Celková cena objednávky se opakuje pro každý řádek položky
                    ].join(',');
                    csvContent += row + "\n";
                }
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "objednavky.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showToast('Objednávky exportovány do CSV!', 'success');
        }

        // --- Admin: Products Tab ---
        let allProductsAdmin = []; // Použijeme jiný název, aby nedošlo ke konfliktu s 'products'
        async function loadProductsAdmin() {
            try {
                const snapshot = await db.collection('products').orderBy('name').get();
                allProductsAdmin = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                displayProductsAdmin();
            } catch (error) {
                console.error("Chyba při načítání produktů pro admina:", error);
                showToast('Chyba při načítání produktů pro admina.', 'error');
            }
        }

        function displayProductsAdmin() {
            const productsListDiv = document.getElementById('productsList');
            productsListDiv.innerHTML = '';
            if (allProductsAdmin.length === 0) {
                productsListDiv.innerHTML = '<p class="text-gray-600">Žádné produkty k zobrazení.</p>';
                return;
            }

            allProductsAdmin.forEach(product => {
                const productElement = document.createElement('div');
                productElement.className = 'bg-white p-4 rounded-lg shadow-md mb-4 border border-gray-200';
                productElement.innerHTML = `
                    <h4 class="font-bold text-lg mb-2">${product.name}</h4>
                    <p class="text-sm text-gray-500 mb-2">Cena: ${formatPrice(product.price)}</p>
                    <p class="text-sm text-gray-500 mb-2">Popis: ${product.description || 'Není k dispozici'}</p>
                    <div class="mt-2 flex justify-end space-x-2">
                        <button onclick="editProduct('${product.id}')" class="bg-yellow-500 text-white px-3 py-1 rounded text-sm hover:bg-yellow-600">Upravit</button>
                        <button onclick="deleteProduct('${product.id}')" class="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600">Smazat</button>
                    </div>
                `;
                productsListDiv.appendChild(productElement);
            });
        }

        async function editProduct(productId) {
            const product = allProductsAdmin.find(p => p.id === productId);
            if (!product) return;

            const newName = prompt('Zadejte nový název produktu:', product.name);
            if (newName === null) return; // User cancelled

            const newPrice = prompt('Zadejte novou cenu produktu:', product.price);
            if (newPrice === null) return; // User cancelled

            const newDescription = prompt('Zadejte nový popis produktu (volitelné):', product.description || '');
            if (newDescription === null) return; // User cancelled

            const parsedPrice = parseFloat(newPrice);
            if (isNaN(parsedPrice) || parsedPrice <= 0) {
                alert('Neplatná cena.');
                return;
            }

            try {
                await db.collection('products').doc(productId).update({
                    name: newName.trim(),
                    price: parsedPrice,
                    description: newDescription.trim()
                });
                showToast('Produkt aktualizován!', 'success');
                loadProductsAdmin();
                loadProducts(); // Refresh main product list
            } catch (error) {
                console.error("Chyba při aktualizaci produktu:", error);
                showToast('Chyba při aktualizaci produktu.', 'error');
            }
        }

        async function deleteProduct(productId) {
            if (confirm('Opravdu chcete smazat tento produkt?')) {
                try {
                    await db.collection('products').doc(productId).delete();
                    showToast('Produkt smazán!', 'success');
                    loadProductsAdmin();
                    loadProducts(); // Refresh main product list
                } catch (error) {
                    console.error("Chyba při mazání produktu:", error);
                    showToast('Chyba při mazání produktu.', 'error');
                }
            }
        }

        async function uploadPdf() {
            const fileInput = document.getElementById('pdfUpload');
            const file = fileInput.files[0];
            const pdfStatusDiv = document.getElementById('pdfStatus');

            if (!file) {
                pdfStatusDiv.textContent = 'Prosím, vyberte PDF soubor.';
                pdfStatusDiv.className = 'mt-2 text-sm text-red-600';
                return;
            }

            pdfStatusDiv.textContent = 'Nahrávám a zpracovávám PDF...';
            pdfStatusDiv.className = 'mt-2 text-sm text-blue-600';

            const reader = new FileReader();
            reader.onload = async (e) => {
                const arrayBuffer = e.target.result;
                try {
                    // Použijeme Cloud Function pro parsování PDF
                    const parsePdfCallable = functions.httpsCallable('parsePdfAndSaveProducts');
                    const result = await parsePdfCallable({ pdfBuffer: Array.from(new Uint8Array(arrayBuffer)) });

                    if (result.data.success) {
                        pdfStatusDiv.textContent = `PDF úspěšně zpracováno. Přidáno/aktualizováno ${result.data.productsCount} produktů.`;
                        pdfStatusDiv.className = 'mt-2 text-sm text-green-600';
                        loadProductsAdmin(); // Refresh admin product list
                        loadProducts(); // Refresh main product list
                    } else {
                        pdfStatusDiv.textContent = `Chyba při zpracování PDF: ${result.data.error}`;
                        pdfStatusDiv.className = 'mt-2 text-sm text-red-600';
                    }
                } catch (error) {
                    console.error("Chyba při volání Cloud Function pro PDF:", error);
                    pdfStatusDiv.textContent = `Chyba při zpracování PDF: ${error.message}`;
                    pdfStatusDiv.className = 'mt-2 text-sm text-red-600';
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // --- Admin: Users Tab ---
        let allUsers = [];
        async function loadUsers() {
            try {
                const snapshot = await db.collection('users').orderBy('name').get();
                allUsers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                filterUsers(); // Display all initially
            } catch (error) {
                console.error("Chyba při načítání uživatelů pro admina:", error);
                showToast('Chyba při načítání uživatelů.', 'error');
            }
        }

        function filterUsers() {
            const searchTerm = document.getElementById('userSearch').value.toLowerCase();
            const filtered = allUsers.filter(user =>
                user.name.toLowerCase().includes(searchTerm) ||
                user.email.toLowerCase().includes(searchTerm)
            );
            displayUsers(filtered);
        }

        function displayUsers(usersToDisplay) {
            const usersListDiv = document.getElementById('usersList');
            usersListDiv.innerHTML = '';
            if (usersToDisplay.length === 0) {
                usersListDiv.innerHTML = '<p class="text-gray-600">Žádní uživatelé k zobrazení.</p>';
                return;
            }

            usersToDisplay.forEach(user => {
                const userElement = document.createElement('div');
                userElement.className = 'bg-white p-4 rounded-lg shadow-md mb-4 border border-gray-200';
                userElement.innerHTML = `
                    <h4 class="font-bold text-lg mb-2">${user.name}</h4>
                    <p class="text-sm text-gray-500 mb-1">E-mail: ${user.email}</p>
                    <p class="text-sm text-gray-500 mb-2">Telefon: ${user.phone || 'Nezadáno'}</p>
                    <div class="mt-2 flex justify-end space-x-2">
                        <button onclick="deleteUser('${user.id}')" class="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600">Smazat uživatele</button>
                    </div>
                `;
                usersListDiv.appendChild(userElement);
            });
        }

        async function deleteUser(userId) {
            if (confirm('Opravdu chcete smazat tohoto uživatele a jeho objednávky?')) {
                try {
                    // Smazání uživatele
                    await db.collection('users').doc(userId).delete();

                    // Smazání všech objednávek tohoto uživatele
                    const userOrdersSnapshot = await db.collection('orders').where('userId', '==', userId).get();
                    const batch = db.batch();
                    userOrdersSnapshot.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    await batch.commit();

                    showToast('Uživatel a jeho objednávky smazány!', 'success');
                    loadUsers(); // Refresh user list
                    loadOrders(); // Refresh order list
                } catch (error) {
                    console.error("Chyba při mazání uživatele:", error);
                    showToast('Chyba při mazání uživatele.', 'error');
                }
            }
        }

        // --- Admin: Settings Tab ---
        async function loadOrderDeadline() {
            try {
                const doc = await db.collection('settings').doc('appSettings').get();
                if (doc.exists && doc.data().orderDeadline) {
                    orderDeadline = doc.data().orderDeadline.toDate();
                    document.getElementById('orderDeadline').value = orderDeadline.toISOString().slice(0, 16);
                    document.getElementById('deadlineStatus').textContent = `Aktuální termín: ${orderDeadline.toLocaleString()}`;
                } else {
                    document.getElementById('orderDeadline').value = '';
                    document.getElementById('deadlineStatus').textContent = 'Termín není nastaven.';
                }
            } catch (error) {
                console.error("Chyba při načítání termínu objednávek:", error);
                document.getElementById('deadlineStatus').textContent = 'Chyba při načítání termínu.';
            }
        }

        async function saveOrderDeadline() {
            const deadlineInput = document.getElementById('orderDeadline').value;
            if (!deadlineInput) {
                alert('Prosím, zadejte datum a čas.');
                return;
            }
            const newDeadline = new Date(deadlineInput);
            if (isNaN(newDeadline.getTime())) {
                alert('Neplatné datum a čas.');
                return;
            }

            try {
                await db.collection('settings').doc('appSettings').set({
                    orderDeadline: firebase.firestore.Timestamp.fromDate(newDeadline)
                }, { merge: true });
                showToast('Termín objednávek uložen!', 'success');
                loadOrderDeadline(); // Refresh displayed deadline
            } catch (error) {
                console.error("Chyba při ukládání termínu objednávek:", error);
                showToast('Chyba při ukládání termínu.', 'error');
            }
        }

        function loadAdminPasswordSetting() {
            // Heslo se načítá z localStorage pro zobrazení (není zobrazeno, jen se nastaví default)
            // Input pole je prázdné, uživatel zadá nové
            document.getElementById('adminPassword').value = '';
            document.getElementById('passwordChangeStatus').textContent = '';
        }

        function changeAdminPassword() {
            const newPassword = document.getElementById('adminPassword').value;
            const passwordChangeStatusDiv = document.getElementById('passwordChangeStatus');

            if (!newPassword || newPassword.length < 4) {
                passwordChangeStatusDiv.textContent = 'Heslo musí mít alespoň 4 znaky.';
                passwordChangeStatusDiv.className = 'text-red-600';
                return;
            }

            localStorage.setItem(ADMIN_PASSWORD_KEY, newPassword);
            passwordChangeStatusDiv.textContent = 'Heslo úspěšně změněno!';
            passwordChangeStatusDiv.className = 'text-green-600';
            showToast('Admin heslo změněno!', 'success');
            document.getElementById('adminPassword').value = ''; // Vyčistit pole
        }

        // --- Admin: Billing Tab ---
        async function updateBilling() {
            const billingListDiv = document.getElementById('billingList');
            billingListDiv.innerHTML = '<p class="text-gray-600">Načítám data pro vyúčtování...</p>';

            try {
                const ordersSnapshot = await db.collection('orders').where('status', '==', 'active').get();
                const usersWithActiveOrders = {}; // Map userId to user data and order data

                // Fetch all users once
                const usersSnapshot = await db.collection('users').get();
                const allUsersMap = {};
                usersSnapshot.forEach(doc => {
                    allUsersMap[doc.id] = doc.data();
                });

                ordersSnapshot.forEach(orderDoc => {
                    const orderData = orderDoc.data();
                    const userId = orderData.userId;
                    const userData = allUsersMap[userId];

                    if (userData) {
                        if (!usersWithActiveOrders[userId]) {
                            usersWithActiveOrders[userId] = {
                                ...userData,
                                orders: []
                            };
                        }
                        usersWithActiveOrders[userId].orders.push(orderData);
                    }
                });

                let html = '';
                if (Object.keys(usersWithActiveOrders).length === 0) {
                    html = '<p class="text-gray-600">Žádní uživatelé s aktivními objednávkami k vyúčtování.</p>';
                } else {
                    for (const userId in usersWithActiveOrders) {
                        const user = usersWithActiveOrders[userId];
                        let userTotal = 0;
                        let userItemsHtml = '';

                        user.orders.forEach(order => {
                            for (const productId in order.items) {
                                const quantity = order.items[productId];
                                const product = products.find(p => p.id === productId);
                                const productName = product ? product.name : `Neznámý produkt (ID: ${productId})`;
                                const itemPrice = product ? product.price : 0;
                                const itemTotal = itemPrice * quantity;
                                userTotal += itemTotal;
                                userItemsHtml += `<li class="text-sm">${productName} x ${quantity} (${formatPrice(itemTotal)})</li>`;
                            }
                        });

                        html += `
                            <div class="bg-white p-4 rounded-lg shadow-md mb-4 border border-gray-200">
                                <h4 class="font-bold text-lg mb-2">${user.name} (${user.email})</h4>
                                <p class="text-sm text-gray-500 mb-2">Telefon: ${user.phone || 'Nezadáno'}</p>
                                <p class="font-semibold mb-2">Položky v aktivních objednávkách:</p>
                                <ul class="list-disc pl-5 mb-2">${userItemsHtml}</ul>
                                <p class="font-bold text-lg text-right">Celkem k vyúčtování: ${formatPrice(userTotal)}</p>
                                <div class="mt-2 flex justify-end space-x-2">
                                    <button onclick="showEmailPreview('${user.id}')" class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600">Náhled emailu</button>
                                    <button onclick="generatePaymentQR('${user.id}', ${userTotal})" class="bg-purple-500 text-white px-3 py-1 rounded text-sm hover:bg-purple-600">QR Kód</button>
                                    <button onclick="sendSingleBillingEmail('${user.id}')" class="bg-green-500 text-white px-3 py-1 rounded text-sm hover:bg-green-600">Odeslat e-mail</button>
                                </div>
                                <div id="qrCodeContainer-${user.id}" class="mt-4 flex justify-center"></div>
                            </div>
                        `;
                    }
                }
                billingListDiv.innerHTML = html;
            } catch (error) {
                console.error("Chyba při načítání dat pro vyúčtování:", error);
                billingListDiv.innerHTML = '<p class="text-red-600">Chyba při načítání dat pro vyúčtování.</p>';
                showToast('Chyba při načítání dat pro vyúčtování.', 'error');
            }
        }

        // Funkce pro odeslání jednoho e-mailu s vyúčtováním
        async function sendSingleBillingEmail(userId) {
            if (!confirm(`Opravdu chcete odeslat vyúčtování e-mailem uživateli s ID: ${userId}?`)) {
                return;
            }
            const sendEmailStatusDiv = document.getElementById('sendEmailStatus');
            sendEmailStatusDiv.innerHTML = `<div class="text-blue-600">Odesílám e-mail uživateli ${userId}, prosím čekejte...</div>`;

            try {
                const sendBillingEmailCallable = functions.httpsCallable('sendBillingEmail');
                const result = await sendBillingEmailCallable({ userId: userId });

                if (result.data.success) {
                    sendEmailStatusDiv.innerHTML = `<div class="text-green-600">✅ E-mail pro uživatele ${userId} úspěšně odeslán: ${result.data.message}</div>`;
                    showToast('E-mail odeslán!', 'success');
                } else {
                    sendEmailStatusDiv.innerHTML = `<div class="text-yellow-600">⚠️ E-mail pro uživatele ${userId} selhal: ${result.data.message}</div>`;
                    showToast('E-mail selhal!', 'error');
                }
            } catch (error) {
                console.error(`Chyba při volání Cloud Function pro ${userId}:`, error);
                sendEmailStatusDiv.innerHTML = `<div class="text-red-600">❌ Chyba při odesílání e-mailu pro ${userId}: ${error.message}</div>`;
                showToast('Chyba při odesílání e-mailu.', 'error');
            }
        }


        // Nová funkce pro odeslání vyúčtování všem uživatelům s aktivní objednávkou
        async function sendAllBillingEmails() {
            if (!confirm('Opravdu chcete odeslat vyúčtování e-mailem všem uživatelům s aktivními objednávkami?')) {
                return;
            }

            const sendEmailStatusDiv = document.getElementById('sendEmailStatus');
            sendEmailStatusDiv.innerHTML = '<div class="text-blue-600">Odesílám e-maily, prosím čekejte...</div>';

            try {
                const ordersSnapshot = await db.collection('orders').where('status', '==', 'active').get();
                const usersWithOrders = new Set();
                ordersSnapshot.forEach(doc => {
                    usersWithOrders.add(doc.data().userId); // Získáme unikátní ID uživatelů
                });

                if (usersWithOrders.size === 0) {
                    sendEmailStatusDiv.innerHTML = '<div class="text-yellow-600">⚠️ Žádné aktivní objednávky k odeslání.</div>';
                    return;
                }

                let successfulSends = 0;
                let failedSends = 0;
                let messages = [];

                // Získáme referenci na Cloud Function
                const sendBillingEmailCallable = functions.httpsCallable('sendBillingEmail');

                for (const userId of usersWithOrders) {
                    try {
                        const result = await sendBillingEmailCallable({ userId: userId });
                        if (result.data.success) {
                            successfulSends++;
                            messages.push(`✅ ${result.data.message}`);
                        } else {
                            failedSends++;
                            messages.push(`⚠️ ${result.data.message}`);
                        }
                    } catch (error) {
                        failedSends++;
                        messages.push(`❌ Chyba při odesílání e-mailu pro ${userId}: ${error.message}`);
                        console.error(`Chyba při volání Cloud Function pro ${userId}:`, error);
                    }
                }

                sendEmailStatusDiv.innerHTML = `
                    <div class="${failedSends > 0 ? 'text-red-600' : 'text-green-600'}">
                        Dokončeno. Úspěšně odesláno: ${successfulSends}, Selhalo: ${failedSends}
                        <div class="mt-2">${messages.join('<br>')}</div>
                    </div>
                `;
                 alert(`Odesílání dokončeno. Úspěšně odesláno: ${successfulSends}, Selhalo: ${failedSends}`);

            } catch (error) {
                console.error("Chyba při spouštění hromadného odesílání e-mailů:", error);
                sendEmailStatusDiv.innerHTML = `<div class="text-red-600">❌ Chyba při spouštění odesílání: ${error.message}</div>`;
            }
        }


        // --- Email Preview for Billing ---
        async function showEmailPreview(userId) {
            const userDoc = await db.collection('users').doc(userId).get();
            if (!userDoc.exists) {
                alert('Uživatel nenalezen.');
                return;
            }
            const userData = userDoc.data();
            const userName = userData.name;
            const userEmail = userData.email;

            const ordersSnapshot = await db.collection('orders')
                .where('userId', '==', userId)
                .where('status', '==', 'active')
                .get();

            if (ordersSnapshot.empty) {
                alert(`Pro uživatele ${userName} (${userEmail}) nejsou žádné aktivní objednávky.`);
                return;
            }

            const order = ordersSnapshot.docs[0].data(); // Předpokládáme jednu aktivní objednávku
            let total = 0;
            let itemsHtml = '';

            const productsSnapshot = await db.collection('products').get();
            const allProducts = {};
            productsSnapshot.forEach(doc => {
                allProducts[doc.id] = doc.data();
            });

            Object.entries(order.items).forEach(([productId, quantity]) => {
                const product = allProducts[productId];
                const productName = product ? product.name : `Neznámý produkt (ID: ${productId})`;
                const itemPrice = product ? product.price : 0;
                const itemTotal = itemPrice * quantity;
                total += itemTotal;

                itemsHtml += `
                    <tr>
                        <td style="border: 1px solid #ddd; padding: 8px;">${productName}</td>
                        <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">${quantity}x</td>
                        <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">${itemPrice} Kč</td>
                        <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">${itemTotal} Kč</td>
                    </tr>
                `;
            });

            const bankAccountIBAN = 'CZ9203000000000219731465'; // Příklad IBAN
            const accountNumberFormatted = '219731465/0300'; // Pro zobrazení v textu

            const emailContent = `
                <p>Ahoj,</p>
                <p>zde je shrnutí tvé aktuální objednávky:</p>
                <table style="width: 100%; border-collapse: collapse; margin-top: 15px; margin-bottom: 20px; border: 1px solid #ddd;">
                    <thead>
                        <tr style="background-color: #f2f2f2;">
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Produkt</th>
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: center;">Počet</th>
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: right;">Cena/ks</th>
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: right;">Celkem</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${itemsHtml}
                    </tbody>
                    <tfoot>
                        <tr style="font-weight: bold; background-color: #e6e6e6;">
                            <td colspan="3" style="border: 1px solid #ddd; padding: 8px; text-align: right;">Celkem k úhradě:</td>
                            <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">${total} Kč</td>
                        </tr>
                    </tfoot>
                </table>
                <p>Pro platbu prosím použij bankovní převod na účet: <strong>${accountNumberFormatted}</strong> (IBAN: ${bankAccountIBAN}) ve výši <strong>${total} Kč</strong>.</p>
                <p style="margin-top: 20px;">Děkujeme za objednávku!</p>
                <p>S pozdravem,<br>Lukáš Vladyka</p>
            `;

            const previewWindow = window.open('', '_blank');
            previewWindow.document.write('<html><head><title>Náhled e-mailu</title>');
            previewWindow.document.write('<style>body { font-family: Arial, sans-serif; }</style>');
            previewWindow.document.write('</head><body>');
            previewWindow.document.write(emailContent);
            previewWindow.document.write('</body></html>');
            previewWindow.document.close();
        }

        // --- QR Code Generation ---
        function generatePaymentQR(userId, amount) {
            const qrCodeContainerId = `qrCodeContainer-${userId}`;
            const container = document.getElementById(qrCodeContainerId);
            container.innerHTML = ''; // Clear previous QR code if any

            const bankAccount = '219731465/0300'; // Příklad bankovního účtu
            const variableSymbol = userId.substring(0, 10); // Použijeme část ID uživatele jako variabilní symbol
            const currency = 'CZK';

            // QR Platba formát: SPD*1.0*ACC:[cislo_uctu]*AM:[castka]*CC:[mena]*MSG:[zprava]*X-VS:[variabilni_symbol]
            const qrText = `SPD*1.0*ACC:${bankAccount}*AM:${amount}*CC:${currency}*MSG:Platba objednavky ${userName}*X-VS:${variableSymbol}`;

            new QRCode(container, {
                text: qrText,
                width: 128,
                height: 128,
                colorDark : "#000000",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H
            });
            showToast('QR kód vygenerován!', 'info');
        }


        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', async () => {
            await loadUserInfo();
            await loadProducts();
            // Není potřeba načítat admin data hned, načtou se při přihlášení do admin panelu
        });
    </script>
</body>
</html>