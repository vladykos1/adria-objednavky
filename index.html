<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADRIA GOLD - Objednávkový systém</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-functions-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        @media print {
            body * {
                visibility: hidden;
            }
            #print-content, #print-content * { /* Cílíme na nový ID pro tisk */
                visibility: visible;
            }
            #print-content {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                font-size: 10pt;
                padding: 15mm; /* Přidán okraj pro tisk */
                box-sizing: border-box;
            }
            #print-content table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 10px;
            }
            #print-content th, #print-content td {
                border: 1px solid #ccc;
                padding: 5px;
                text-align: left;
            }
            #print-content .text-right {
                text-align: right;
            }
            #print-content h2, #print-content h3 {
                text-align: center;
                margin-bottom: 10px;
            }
            #print-content .break-after {
                page-break-after: always; /* Vynucení nové stránky po každé objednávce */
            }
        }
    </style>
</head>
<body class="bg-gray-100">
    <div id="mainScreen" class="min-h-screen p-4">
        <div class="max-w-6xl mx-auto">
            <div class="bg-white rounded-lg shadow-xl p-6 mb-6">
                <div class="flex justify-between items-center">
                    <h1 class="text-3xl font-bold text-gray-800">ADRIA GOLD - Objednávky</h1>
                    <button onclick="showAdminLogin()" class="text-gray-500 hover:text-gray-700 text-sm">
                        Admin přístup
                    </button>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-xl p-6 mb-6">
                <h2 class="text-xl font-bold mb-4">1. Vyberte osobu</h2>
                <input type="text" id="userSearch" placeholder="Začněte psát jméno..." 
                       class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                       oninput="searchUsers()">
                <div id="userSearchResults" class="mt-2 bg-white border rounded-lg shadow-lg hidden max-h-60 overflow-y-auto"></div>
                <div id="selectedUser" class="mt-4 p-4 bg-blue-50 rounded-lg hidden">
                    <span class="font-semibold">Vybraná osoba:</span> <span id="selectedUserName"></span>
                </div>
            </div>

            <div id="productSection" class="bg-white rounded-lg shadow-xl p-6 mb-6 hidden">
                <h2 class="text-xl font-bold mb-4">2. Přidejte produkty</h2>
                <input type="text" id="productSearch" placeholder="Hledat produkt podle názvu nebo ID..." 
                       class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
                       oninput="searchProducts()">
                <div id="productSearchResults" class="mt-2 bg-white border rounded-lg shadow-lg hidden max-h-60 overflow-y-auto"></div>
                
                <div id="manualProductAdd" class="mt-4 hidden p-4 bg-gray-50 rounded-lg border">
                    <h4 class="font-semibold mb-2">Vybraný produkt pro přidání:</h4>
                    <div class="flex flex-col sm:flex-row items-center space-y-2 sm:space-y-0 sm:space-x-4">
                        <span id="selectedProductName" class="font-medium text-lg flex-grow"></span>
                        <input type="hidden" id="selectedProductId">
                        <input type="number" id="productQuantityInput" value="1" min="1" 
                               class="w-24 px-3 py-2 border rounded-lg text-center"
                               onchange="this.value = Math.max(1, parseInt(this.value) || 1)">
                        <button onclick="addProductToOrderManual()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
                            Přidat/Aktualizovat
                        </button>
                    </div>
                </div>
            </div>

            <div id="orderSection" class="bg-white rounded-lg shadow-xl p-6 hidden">
                <h2 class="text-xl font-bold mb-4">3. Objednávka</h2>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="border-b">
                                <th class="text-left p-2">Produkt</th>
                                <th class="text-center p-2 w-32">Počet</th>
                                <th class="text-right p-2 w-32">Cena/ks</th>
                                <th class="text-right p-2 w-32">Celkem</th>
                                <th class="w-16"></th>
                            </tr>
                        </thead>
                        <tbody id="orderItems"></tbody>
                        <tfoot>
                            <tr class="border-t font-bold">
                                <td colspan="3" class="p-2 text-right">Celkem:</td>
                                <td class="p-2 text-right text-xl" id="totalPrice">0 Kč</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>

            </div>
    </div>

    <div id="adminPanel" class="hidden min-h-screen p-4">
        <div class="max-w-7xl mx-auto">
            <div class="bg-white rounded-lg shadow-xl p-6 mb-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Admin Panel</h2>
                    <button onclick="backToMain()" class="text-red-600 hover:text-red-800">Zpět</button>
                </div>

                <div class="border-b mb-6">
                    <nav class="flex space-x-8">
                        <button onclick="showAdminTab('orders')" class="admin-tab pb-2 border-b-2 border-blue-600">Objednávky</button>
                        <button onclick="showAdminTab('products')" class="admin-tab pb-2">Produkty</button>
                        <button onclick="showAdminTab('import')" class="admin-tab pb-2">Import dat</button>
                        <button onclick="showAdminTab('billing')" class="admin-tab pb-2">Vyúčtování</button>
                        <button onclick="showAdminTab('settings')" class="admin-tab pb-2">Nastavení</button>
                    </nav>
                </div>

                <div id="ordersTab" class="admin-tab-content">
                    <div class="mb-4 flex justify-between print-hidden">
                        <h3 class="text-xl font-semibold">Aktuální objednávky</h3>
                        <div class="space-x-2">
                            <input type="text" id="orderSearch" placeholder="Hledat uživatele nebo status..." 
                               class="px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                               oninput="filterOrders()">
                            <button onclick="exportOrdersToCSV()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                                Export CSV pro eshop
                            </button>
                             <button onclick="printOrders()" class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700">
                                Tisk přehledu
                            </button>
                        </div>
                    </div>
                    <div id="ordersList" class="overflow-x-auto"></div>
                     <div id="print-content" style="display: none;"></div> 
                </div>

                <div id="productsTab" class="admin-tab-content hidden">
                    <div class="mb-6">
                        <h3 class="text-xl font-semibold mb-4">Import ceníku z PDF</h3>
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center">
                            <input type="file" id="pdfUpload" accept=".pdf" class="hidden" onchange="handlePDFUpload(event)">
                            <label for="pdfUpload" class="cursor-pointer">
                                <div class="text-gray-600">
                                    <p class="text-lg">Klikněte pro nahrání PDF ceníku</p>
                                    <p class="text-sm mt-2">Nebo přetáhněte soubor sem</p>
                                </div>
                            </label>
                        </div>
                        <div id="pdfStatus" class="mt-4"></div>
                    </div>
                    <div id="productsList" class="mt-6"></div>
                </div>

                <div id="importTab" class="admin-tab-content hidden">
                    <h3 class="text-xl font-semibold mb-4">Hromadný import dat</h3>
                    
                    <div class="bg-gray-50 rounded-lg p-6 mb-6">
                        <h4 class="font-semibold mb-4">Import uživatelů</h4>
                        <div class="mb-3">
                            <label class="text-sm text-gray-600">Formát dat:</label>
                            <select id="userImportDelimiter" class="ml-2 border rounded px-2 py-1">
                                <option value="auto">Automaticky rozpoznat</option>
                                <option value="tab">Tabulátor (TAB)</option>
                                <option value="semicolon">Středník (;)</option>
                                <option value="comma">Čárka (,)</option>
                            </select>
                        </div>
                        <p class="text-sm text-gray-600 mb-2">Formát: Jméno;Email (nebo oddělené tabulátorem)</p>
                        <textarea id="importUsersData" rows="10" class="w-full border rounded p-2 mb-2 font-mono text-sm" 
                            placeholder="Jan Novák;jan.novak@firma.cz
Marie Svobodová;marie.svobodova@firma.cz"></textarea>
                        <button onclick="importUsersData()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                            Import uživatelů
                        </button>
                        <div id="importUsersResult" class="mt-2"></div>
                    </div>

                    <div class="bg-gray-50 rounded-lg p-6">
                        <h4 class="font-semibold mb-4">Import produktů</h4>
                        <div class="mb-3">
                            <label class="text-sm text-gray-600">Formát dat:</label>
                            <select id="productImportDelimiter" class="ml-2 border rounded px-2 py-1">
                                <option value="auto">Automaticky rozpoznat</option>
                                <option value="tab">Tabulátor (TAB)</option>
                                <option value="semicolon">Středník (;)</option>
                                <option value="comma">Čárka (,)</option>
                            </select>
                        </div>
                        <p class="text-sm text-gray-600 mb-2">Formát: Název;ID;Cena (flexibilní pořadí)</p>
                        <textarea id="importProductsData" rows="10" class="w-full border rounded p-2 mb-2 font-mono text-sm" 
                            placeholder="Slaný karamel s vanilkou 210g;740005;128
Jogurt prolévaný ovocem 2,4l;705015;307"></textarea>
                        <button onclick="importProductsData()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
                            Import produktů
                        </button>
                        <div id="importProductsResult" class="mt-2"></div>
                    </div>
                </div>

                <div id="billingTab" class="admin-tab-content hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold">Vyúčtování</h3>
                        <div id="totalBillingAmount" class="text-lg font-bold text-right text-green-700"></div>
                    </div>
                    <div id="billingList"></div>
                    <button onclick="sendAllBillingEmails()" class="mt-4 bg-green-700 text-white px-4 py-2 rounded hover:bg-green-800">
                        Odeslat vyúčtování všem nezaplaceným
                    </button>
                    <div id="sendEmailStatus" class="mt-2 text-sm text-gray-700"></div>
                </div>

                <div id="settingsTab" class="admin-tab-content hidden">
                    <h3 class="text-xl font-semibold mb-4">Nastavení</h3>
                    <div class="space-y-4">
                        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between p-4 bg-gray-50 rounded">
                            <span>Příjem objednávek do:</span>
                            <div class="mt-2 sm:mt-0 flex items-center space-x-2">
                                <input type="datetime-local" id="orderingDeadline" class="px-3 py-2 border rounded-lg">
                                <button onclick="setOrderingDeadline()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                                    Uložit termín
                                </button>
                            </div>
                        </div>
                        <div id="orderingStatus" class="mt-2 text-sm text-gray-700"></div>
                        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between p-4 bg-gray-50 rounded">
                            <span>Změnit admin heslo:</span>
                            <div class="mt-2 sm:mt-0 flex items-center space-x-2">
                                <input type="password" id="adminNewPassword" class="px-3 py-2 border rounded-lg" placeholder="Nové heslo">
                                <button onclick="changeAdminPassword()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                                    Změnit
                                </button>
                            </div>
                        </div>
                        <div id="passwordChangeStatus" class="mt-2 text-sm text-gray-700"></div>
                        <button onclick="resetAllOrders()" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">
                            Resetovat všechny objednávky
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
    <script>
        // Nastavení workerSrc pro pdf.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js';
    </script>
    <script>
        // --- Globální proměnné ---
        let currentUser = null;
        let products = {};
        let users = {};
        let currentOrder = {};
        let currentOrderId = null;
        let orderingDeadline = null;
        const ADMIN_PASSWORD_KEY = 'admingold_password';
        const ADMIN_DEFAULT_PASSWORD = 'admin123';
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAdhvcOnksDf_cUGp5MUfjHnghH4d4KVg8",
            authDomain: "adria-gold-objednavky.firebaseapp.com",
            projectId: "adria-gold-objednavky",
            storageBucket: "adria-gold-objednavky.firebasestorage.app",
            messagingSenderId: "643448659480",
            appId: "1:643448659480:web:bd0ea9b3c92deebe6bed6d"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const storage = firebase.storage();
        const functions = firebase.functions();
        
        // --- Funkce ---
        function showAdminLogin() {
            const storedPassword = localStorage.getItem(ADMIN_PASSWORD_KEY);
            let passwordPrompt = prompt('Zadejte admin heslo:');

            if (passwordPrompt === (storedPassword || ADMIN_DEFAULT_PASSWORD)) {
                sessionStorage.setItem('isAdminLoggedIn', 'true');
                document.getElementById('mainScreen').classList.add('hidden');
                document.getElementById('adminPanel').classList.remove('hidden');
                loadAdminData(); // Načte data pro admin panel po přihlášení
            } else if (passwordPrompt) { 
                alert('Nesprávné heslo');
            }
        }

        function backToMain() {
            sessionStorage.removeItem('isAdminLoggedIn');
            document.getElementById('adminPanel').classList.add('hidden');
            document.getElementById('mainScreen').classList.remove('hidden');
        }

        function checkAdminAuthStatus() {
            if (sessionStorage.getItem('isAdminLoggedIn') === 'true') {
                document.getElementById('mainScreen').classList.add('hidden');
                document.getElementById('adminPanel').classList.remove('hidden');
                loadAdminData();
            }
        }

        async function loadAdminData() {
            await loadProducts();
            await loadUsers();
            await loadOrders();
            if (typeof displayProductsAdmin === 'function') displayProductsAdmin();
            if (typeof displayProducts === 'function') displayProducts();
        }
        
        // Pomocná funkce pro přepínání záložek
        function showAdminTab(tabId) {
            document.querySelectorAll('.admin-tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            document.getElementById(tabId + 'Tab').classList.remove('hidden');

            document.querySelectorAll('.admin-tab').forEach(button => {
                button.classList.remove('border-b-2', 'border-blue-600');
            });
            document.querySelector(`.admin-tab[onclick="showAdminTab('${tabId}')"]`).classList.add('border-b-2', 'border-blue-600');
        }


        // --- Admin: Orders Tab ---
        let allOrders = []; // Globální proměnná pro všechny objednávky v adminu
        async function loadOrders() {
            await loadProducts(); // Zajistí, že produkty jsou aktuální
            try {
                // Načítáme všechny objednávky pro zobrazení
                const snapshot = await db.collection('orders').orderBy('timestamp', 'desc').get();
                allOrders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); // ID je zde dokument ID (e-mail uživatele)
                filterOrders(); // Zobrazíme všechny po načtení (nebo filtrované, pokud je hledání aktivní)
            } catch (error) {
                console.error("Chyba při načítání objednávek pro admina:", error);
                alert('Chyba při načítání objednávek pro admina.');
            }
        }
        
        // Funkce pro filtrování objednávek (pro vyhledávání)
        function filterOrders() {
            const searchTerm = document.getElementById('orderSearch').value.toLowerCase();
            const filteredOrders = allOrders.filter(order =>
                order.userName.toLowerCase().includes(searchTerm) ||
                order.userEmail.toLowerCase().includes(searchTerm) ||
                (order.status && order.status.toLowerCase().includes(searchTerm)) ||
                (order.paid !== undefined && (searchTerm === 'zaplaceno' && order.paid || searchTerm === 'nezaplaceno' && !order.paid))
            );
            displayOrders(filteredOrders);
        }

        // Funkce pro zobrazení objednávek (používá se i pro filtrované)
        function displayOrders(ordersToDisplay) {
            const ordersListDiv = document.getElementById('ordersList');
            ordersListDiv.innerHTML = '';
            if (ordersToDisplay.length === 0) {
                ordersListDiv.innerHTML = '<p class="text-gray-600 p-4">Žádné objednávky k zobrazení.</p>';
                return;
            }
            ordersToDisplay.forEach(order => {
                let itemsHtml = '';
                let orderTotal = 0;
                for (const productId in order.items) {
                    const quantity = order.items[productId];
                    const product = products[productId];
                    const productName = product ? product.name : `Neznámý produkt (ID: ${productId})`;
                    const itemPrice = product ? product.price : 0;
                    const itemTotal = itemPrice * quantity;
                    orderTotal += itemTotal;
                    itemsHtml += `<li class="text-sm">${productName} x ${quantity} (${itemPrice} Kč/ks) = ${itemTotal} Kč</li>`;
                }
                // OPRAVA: vylepšená logika pro získání jména uživatele
                const displayName = order.userName || users[order.userEmail]?.name || users[order.userId]?.name || order.userEmail || order.userId || 'Neznámý uživatel';
                const paymentStatus = order.paid ? '<span class="text-green-600 font-bold">Zaplaceno</span>' : '<span class="text-red-600 font-bold">Nezaplaceno</span>';
                const markPaidButton = order.paid 
                    ? `<button onclick="togglePaymentStatus('${order.id}', false)" class="bg-yellow-500 text-white px-3 py-1 rounded text-sm hover:bg-yellow-600">Označit jako Nezaplaceno</button>`
                    : `<button onclick="togglePaymentStatus('${order.id}', true)" class="bg-green-500 text-white px-3 py-1 rounded text-sm hover:bg-green-600">Označit jako Zaplaceno</button>`;
                const orderElement = document.createElement('div');
                orderElement.className = 'bg-white p-4 rounded-lg shadow-md mb-4 border border-gray-200';
                orderElement.innerHTML = `
                    <h4 class="font-bold text-lg mb-2">${displayName} (${order.userEmail})</h4>
                    <p class="text-sm text-gray-500 mb-2">Datum: ${order.timestamp ? new Date(order.timestamp.toDate()).toLocaleString('cs-CZ') : 'N/A'}</p>
                    <p class="font-semibold mb-2">Položky:</p>
                    <ul class="list-disc pl-5 mb-2">${itemsHtml}</ul>
                    <p class="font-bold text-lg text-right">Celkem: ${orderTotal} Kč</p>
                    <p class="text-md font-semibold text-right">Stav platby: ${paymentStatus}</p>
                    <div class="mt-2 flex justify-end space-x-2">
                        ${markPaidButton}
                        <button onclick="deleteOrder('${order.id}')" class="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600">Smazat</button>
                    </div>
                `;
                ordersListDiv.appendChild(orderElement);
            });
        }

        async function togglePaymentStatus(orderId, isPaid) {
            try {
                await db.collection('orders').doc(orderId).update({ paid: isPaid });
                alert(`Objednávka ${orderId} označena jako ${isPaid ? 'zaplacená' : 'nezaplacená'}.`);
                loadOrders(); // Znovu načíst objednávky pro aktualizaci zobrazení
                updateBilling(); // Aktualizovat i záložku vyúčtování
            } catch (error) {
                console.error("Chyba při změně statusu platby:", error);
                alert('Chyba při změně statusu platby: ' + error.message);
            }
        }

        async function deleteOrder(orderId) {
            if (confirm('Opravdu chcete smazat tuto objednávku? Tato akce je nevratná.')) {
                try {
                    await db.collection('orders').doc(orderId).delete();
                    alert('Objednávka smazána!');
                    loadOrders(); 
                    updateBilling(); // Aktualizovat i záložku vyúčtování
                } catch (error) {
                    console.error("Chyba při mazání objednávky:", error);
                    alert('Chyba při mazání objednávky: ' + error.message);
                }
            }
        }

        async function printOrders() {
            await loadProducts(); // Zajistí, že produkty jsou aktuální
            const printWindow = window.open('', '', 'height=600,width=800');
            printWindow.document.write('<html><head><title>Tisk objednávek</title>');
            printWindow.document.write('<style>'+`
                body { font-family: sans-serif; margin: 0; padding: 20px; }
                table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
                th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
                th { background-color: #f2f2f2; }
                .text-right { text-align: right; }
                h2, h3 { text-align: center; margin-bottom: 10px; }
                .break-after { page-break-after: always; }
                .order-section { margin-bottom: 20px; page-break-inside: avoid; }
            `+'</style>');
            printWindow.document.write('</head><body>');

            // Globální souhrn produktů
            let globalProductSummary = {};
            allOrders.forEach(order => {
                Object.entries(order.items).forEach(([productId, quantity]) => {
                    globalProductSummary[productId] = (globalProductSummary[productId] || 0) + quantity;
                });
            });

            printWindow.document.write('<h1 style="text-align: center;">ADRIA GOLD - Přehled objednávek</h1>');
            printWindow.document.write('<p style="text-align: center;">Datum: ' + new Date().toLocaleDateString('cs-CZ') + '</p>');

            printWindow.document.write('<h2 style="text-align: center; margin-top: 30px;">Souhrn produktů pro přípravu:</h2>');
            printWindow.document.write('<table><thead><tr><th>Produkt</th><th style="text-align:center;">ID</th><th style="text-align:center;">Celkem kusů</th></tr></thead><tbody>');
            Object.entries(globalProductSummary).forEach(([productId, totalQuantity]) => {
                const product = products[productId];
                const productName = product ? product.name : `Neznámý produkt (ID: ${productId})`;
                printWindow.document.write(`<tr><td>${productName}</td><td style="text-align:center;">${productId}</td><td style="text-align:center; font-weight:bold;">${totalQuantity}</td></tr>`);
            });
            printWindow.document.write('</tbody></table>');

            // Detailní přehled objednávek
            printWindow.document.write('<h2 style="text-align: center; margin-top: 30px;">Detailní objednávky dle uživatelů:</h2>');
            allOrders.forEach((order, index) => {
                let itemsDetailHtml = '';
                let orderTotal = 0;
                Object.entries(order.items).forEach(([productId, quantity]) => {
                    const product = products[productId];
                    const productName = product ? product.name : `Neznámý produkt (ID: ${productId})`;
                    const itemPrice = product ? product.price : 0;
                    const itemTotal = itemPrice * quantity;
                    orderTotal += itemTotal;
                    itemsDetailHtml += `<tr><td>${productName}</td><td style="text-align:center;">${quantity}x</td><td style="text-align:right;">${itemPrice} Kč</td><td style="text-align:right;">${itemTotal} Kč</td></tr>`;
                });
                const paymentStatus = order.paid ? 'Zaplaceno' : 'Nezaplaceno';

                printWindow.document.write(`
                    <div class="order-section">
                        <h3 style="margin-bottom: 5px;">Objednávka pro: ${order.userName || users[order.userEmail]?.name || users[order.userId]?.name || 'Neznámý uživatel'} (${order.userEmail})</h3>
                        <p style="font-size: 0.9em; margin-bottom: 10px;">Datum: ${order.timestamp ? new Date(order.timestamp.toDate()).toLocaleString('cs-CZ') : 'N/A'}</p>
                        <table>
                            <thead>
                                <tr>
                                    <th>Produkt</th>
                                    <th style="text-align:center;">Počet</th>
                                    <th style="text-align:right;">Cena/ks</th>
                                    <th style="text-align:right;">Celkem</th>
                                </tr>
                            </thead>
                            <tbody>${itemsDetailHtml}</tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="3" style="text-align:right; font-weight:bold;">Celkem:</td>
                                    <td style="text-align:right; font-weight:bold;">${orderTotal} Kč</td>
                                </tr>
                                <tr>
                                    <td colspan="4" style="text-align:right; font-weight:bold;">Stav platby: ${paymentStatus}</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                `);
                if (index < allOrders.length - 1) { // Přidat zalomení stránky mezi objednávkami
                    printWindow.document.write('<div class="break-after"></div>');
                }
            });

            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.print();
        }


        async function exportOrdersToCSV() {
            if (!allOrders || allOrders.length === 0) {
                alert('Nejsou žádné objednávky k exportu.');
                return;
            }

            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Jméno,Email,Telefon,Datum Objednávky,Status Platby,Produkt ID,Název Produktu,Množství,Cena/ks,Celkem Položky,Celkem Objednávky\n";

            allOrders.forEach(order => {
                let orderTotal = 0;
                for (const productId in order.items) {
                    const quantity = order.items[productId];
                    const product = products[productId];
                    const itemPrice = product ? product.price : 0;
                    orderTotal += itemPrice * quantity;
                }

                for (const productId in order.items) {
                    const quantity = order.items[productId];
                    const product = products[productId];
                    const productName = product ? product.name : `Neznámý produkt (ID: ${productId})`;
                    const itemPrice = product ? product.price : 0;
                    const itemTotal = itemPrice * quantity;
                    const paymentStatus = order.paid ? 'Zaplaceno' : 'Nezaplaceno';

                    const row = [
                        `"${order.userName || users[order.userEmail]?.name || users[order.userId]?.name || 'Neznámý uživatel'}""`,
                        `"${order.userEmail}"`,
                        `"${order.userPhone || 'Nezadáno'}"`, 
                        `"${order.timestamp ? new Date(order.timestamp.toDate()).toLocaleString('cs-CZ') : 'N/A'}"`,
                        `"${paymentStatus}"`, 
                        `"${productId}"`, 
                        `"${productName}"`,
                        quantity,
                        itemPrice,
                        itemTotal,
                        orderTotal 
                    ].map(item => String(item).replace(/"/g, '""')).join(','); 
                    csvContent += row + "\n";
                }
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `objednavky_export_${new Date().toISOString().slice(0,10)}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            alert('Objednávky exportovány do CSV!');
        }
        
        // --- Admin: Products Tab ---
        // Produkty pro admin panel (s možností editace/mazání)
        // Používáme globální 'products' objekt pro data
        async function displayProductsAdmin(page = 0) {
            await loadProducts();
            const productsListDiv = document.getElementById('productsList');
            productsListDiv.innerHTML = '<p class="text-gray-600 p-4">Načítám produkty...</p>';
            const productArray = Object.values(products);
            let html = '<div class="mb-4 flex justify-between items-center">' +
                       '<h4 class="font-semibold">Aktuální produkty:</h4>' +
                       '<input type="text" placeholder="Hledat produkt..." onkeyup="filterProductsAdmin(this.value)" class="px-3 py-1 border rounded">' +
                       '</div>';
            if (productArray.length === 0) {
                html += '<p class="text-gray-600 p-4">Žádné produkty k zobrazení.</p>';
                productsListDiv.innerHTML = html;
                return;
            }
            const productsPerPage = 20;
            const totalPages = Math.ceil(productArray.length / productsPerPage);
            const start = page * productsPerPage;
            const end = start + productsPerPage;
            const pageProducts = productArray.slice(start, end);
            html += '<div class="overflow-x-auto"><table class="w-full"><thead><tr class="bg-gray-100">' +
                '<th class="p-2 text-left">ID</th>' +
                '<th class="p-2 text-left">Název</th>' +
                '<th class="p-2 text-right">Cena</th>' +
                '<th class="p-2 text-center">Akce</th>' +
                '</tr></thead><tbody id="productsTableBody">';
            pageProducts.forEach(product => {
                html += `
                    <tr class="border-b product-row">
                        <td class="p-2">${product.id}</td>
                        <td class="p-2">${product.name}</td>
                        <td class="p-2 text-right">${product.price} Kč</td>
                        <td class="p-2 text-center">
                            <button onclick="editProduct('${product.id}')" class="bg-yellow-500 text-white px-3 py-1 rounded text-sm hover:bg-yellow-600">Upravit</button>
                            <button onclick="deleteProduct('${product.id}')" class="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600 ml-1">Smazat</button>
                        </td>
                    </tr>
                `;
            });
            html += '</tbody></table></div>';
            if (totalPages > 1) {
                html += '<div class="mt-4 flex justify-center space-x-2">';
                for (let i = 0; i < totalPages; i++) {
                    html += `<button onclick="displayProductsAdmin(${i})" class="px-3 py-1 rounded ${i === page ? 'bg-blue-600 text-white' : 'bg-gray-200 hover:bg-gray-300'}">${i + 1}</button>`;
                }
                html += '</div>';
            }
            html += `<p class="text-sm text-gray-600 mt-2">Zobrazeno ${pageProducts.length} z ${Object.keys(products).length} produktů</p>`;
            productsListDiv.innerHTML = html;
        }
        
        function filterProductsAdmin(query) {
            const rows = document.querySelectorAll('#productsTableBody .product-row');
            const lowerQuery = query.toLowerCase();
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(lowerQuery) ? '' : 'none';
            });
        }

        async function editProduct(productId) {
            const product = products[productId]; // Používáme globální 'products' objekt
            if (!product) return;

            const newName = prompt('Zadejte nový název produktu:', product.name);
            if (newName === null || !newName.trim()) return;

            const newPriceStr = prompt('Zadejte novou cenu produktu:', product.price);
            if (newPriceStr === null || !newPriceStr.trim()) return;
            const newPrice = parseFloat(newPriceStr.replace(',', '.')); 

            if (isNaN(newPrice) || newPrice < 0) {
                alert('Neplatná cena.');
                return;
            }

            try {
                await db.collection('products').doc(productId).update({
                    name: newName.trim(),
                    price: newPrice
                });
                alert('Produkt aktualizován!');
                await loadProducts(); // Znovu načíst produkty na hlavní obrazovce a v globální proměnné
                displayProductsAdmin(); // Znovu zobrazit v adminu
            } catch (error) {
                console.error("Chyba při aktualizaci produktu:", error);
                alert('Chyba při aktualizaci produktu: ' + error.message);
            }
        }

        async function deleteProduct(productId) {
            if (confirm('Opravdu chcete smazat tento produkt? Tato akce je nevratná.')) {
                try {
                    await db.collection('products').doc(productId).delete();
                    alert('Produkt smazán!');
                    await loadProducts(); // Znovu načíst produkty na hlavní obrazovce a v globální proměnné
                    displayProductsAdmin(); // Znovu zobrazit v adminu
                } catch (error) {
                    console.error("Chyba při mazání produktu:", error);
                    alert('Chyba při mazání produktu: ' + error.message);
                }
            }
        }
        
        // --- PDF Import (Admin Panel) ---
        async function handlePDFUpload(event) {
            const file = event.target.files[0];
            const pdfStatusDiv = document.getElementById('pdfStatus');
            
            if (!file || !file.type.includes('pdf')) {
                pdfStatusDiv.innerHTML = '<div class="text-red-600">Vyberte PDF soubor.</div>';
                return;
            }

            pdfStatusDiv.innerHTML = '<div class="text-blue-600">Zpracovávám PDF, prosím čekejte...</div>';

            const reader = new FileReader();
            reader.onload = async function() {
                const arrayBuffer = reader.result;
                try {
                    const loadingTask = pdfjsLib.getDocument({ data: arrayBuffer });
                    const pdf = await loadingTask.promise;
                    let fullText = '';

                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const textContent = await page.getTextContent();
                        fullText += textContent.items.map(item => item.str).join(' ') + '\n'; 
                    }
                    
                    await parsePDFTextForProducts(fullText);
                    pdfStatusDiv.innerHTML = '<div class="text-green-600">✅ PDF zpracováno a data importována.</div>';
                    await loadProducts(); // Znovu načíst produkty (aktualizuje globální 'products' a hlavní obrazovku)
                    displayProductsAdmin(); // Znovu zobrazit produkty v admin panelu
                } catch (error) {
                    console.error('Chyba při zpracování PDF:', error);
                    pdfStatusDiv.innerHTML = `<div class="text-red-600">❌ Chyba při zpracování PDF: ${error.message}</div>`;
                }
            };
            reader.readAsArrayBuffer(file);
        }

        async function parsePDFTextForProducts(text) {
            const lines = text.split('\n');
            let importedCount = 0;
            let errorCount = 0;

            // Nový robustní regex: ID (6 číslic), název (greedy), objem (volitelný), cena (číslo), Kč
            // Příklad: 740005 Slaný karamel s vanilkou 210g 128 Kč
            const productRegex = /^(\d{6})\s+(.+?)(?:\s+(\d+ml|\d+g))?\s+(\d+)\s*Kč$/i;

            let batch = db.batch();
            let batchCount = 0;

            for (const line of lines) {
                const trimmedLine = line.trim();
                const match = trimmedLine.match(productRegex);

                if (match) {
                    let id = match[1];
                    let name = match[2].trim();
                    let volume = match[3] ? match[3].trim() : '';
                    let priceStr = match[4];
                    let price = parseInt(priceStr);
                    if (volume) name = name + ' ' + volume;

                    // Kontrola platnosti
                    if (id && name && !isNaN(price) && id.length === 6) {
                        const productRef = db.collection('products').doc(id);
                        batch.set(productRef, {
                            name: name,
                            price: price
                        }, { merge: true }); 
                        importedCount++;
                        batchCount++;

                        if (batchCount >= 400) { // Limit pro dávkové zápisy
                            await batch.commit();
                            batch = db.batch();
                            batchCount = 0;
                        }
                    } else {
                        errorCount++;
                        console.warn('Nepodařilo se parsovat řádek (neplatné ID, název nebo cena):', trimmedLine);
                    }
                } else {
                     // Zaznamenej řádky, které neodpovídají regexu (např. hlavičky, zápatí, atd.)
                    // console.log("Řádek neodpovídá formátu:", trimmedLine);
                }
            }

            if (batchCount > 0) { 
                await batch.commit();
            }

            alert(`Import PDF dokončen! Importováno: ${importedCount} produktů. Chyb: ${errorCount}.`);
        }
        
        // --- Admin: Import Data (Manual Import) ---
        async function importUsersData() {
            const data = document.getElementById('importUsersData').value.trim();
            if (!data) {
                alert('Vlož data uživatelů');
                return;
            }

            const resultDiv = document.getElementById('importUsersResult');
            resultDiv.innerHTML = '<div class="text-blue-600">Importuji...</div>';

            try {
                const lines = data.split('\n');
                let imported = 0;
                let errors = 0;

                const delimiterType = document.getElementById('userImportDelimiter').value;
                let delimiter = '\t';
                
                if (delimiterType === 'auto') {
                    const firstLine = lines[0];
                    if (firstLine.includes('\t')) delimiter = '\t';
                    else if (firstLine.includes(';')) delimiter = ';';
                    else if (firstLine.includes(',')) delimiter = ',';
                } else {
                    delimiter = {
                        'tab': '\t',
                        'semicolon': ';',
                        'comma': ','
                    }[delimiterType];
                }

                for (const line of lines) {
                    if (!line.trim()) continue;
                    
                    const parts = line.split(delimiter).map(p => p.trim());
                    
                    if (parts.length >= 2) {
                        let email, name;
                        if (parts[0].includes('@')) {
                            email = parts[0];
                            name = parts[1];
                        } else if (parts[1].includes('@')) {
                            name = parts[0];
                            email = parts[1];
                        } else {
                            errors++;
                            continue;
                        }
                        
                        try {
                            await db.collection('users').doc(email).set({
                                email: email,
                                name: name
                            });
                            imported++;
                        } catch (err) {
                            errors++;
                        }
                    }
                }

                resultDiv.innerHTML = `<div class="text-green-600">✅ Import dokončen! Importováno: ${imported} uživatelů${errors > 0 ? `<br>⚠️ Chyby: ${errors}` : ''}</div>`;
                await loadUsers(); // Znovu načíst uživatele pro aktualizaci všech seznamů
            } catch (error) {
                resultDiv.innerHTML = `<div class="text-red-600">❌ Chyba: ${error.message}</div>`;
            }
        }

        async function importProductsData() {
            const data = document.getElementById('importProductsData').value.trim();
            if (!data) {
                alert('Vlož data produktů');
                return;
            }

            const resultDiv = document.getElementById('importProductsResult');
            resultDiv.innerHTML = '<div class="text-blue-600">Importuji...</div>';

            try {
                const lines = data.split('\n');
                let imported = 0;
                let errors = 0;
                let errorDetails = [];

                const delimiterType = document.getElementById('productImportDelimiter').value;
                let delimiter = '\t';
                
                if (delimiterType === 'auto') {
                    const firstLine = lines[0];
                    if (firstLine.includes('\t')) delimiter = '\t';
                    else if (firstLine.includes(';')) delimiter = ';';
                    else if (firstLine.includes(',')) delimiter = ',';
                } else {
                    delimiter = {
                        'tab': '\t',
                        'semicolon': ';',
                        'comma': ','
                    }[delimiterType];
                }

                // Použít batch pro efektivnější import
                let batch = db.batch();
                let batchCount = 0;

                for (const line of lines) {
                    if (!line.trim()) continue;
                    
                    const parts = line.split(delimiter).map(p => p.trim());
                    
                    if (parts.length >= 3) {
                        let id, name, price;
                        
                        const idPattern = /^\d{6}$/;
                        
                        if (idPattern.test(parts[0])) {
                            id = parts[0];
                            name = parts[1];
                            price = parts[2];
                        } else if (idPattern.test(parts[1])) {
                            name = parts[0];
                            id = parts[1];
                            price = parts[2];
                        } else if (idPattern.test(parts[2])) {
                            name = parts[0];
                            price = parts[1];
                            id = parts[2];
                        } else {
                            errors++;
                            errorDetails.push(`Neplatné ID v řádku: ${line}`);
                            continue;
                        }
                        
                        // Vylepšené zpracování ceny - odstraní všechny nečíselné znaky kromě desetinné čárky/tečky
                        price = price.replace(/[^\d,.-]/g, '').replace(',', '.');
                        const priceNum = parseFloat(price);
                        
                        if (id && name && !isNaN(priceNum) && priceNum >= 0) {
                            try {
                                const productRef = db.collection('products').doc(id);
                                batch.set(productRef, {
                                    name: name,
                                    price: Math.round(priceNum)
                                }, { merge: true }); // merge: true zachová existující data a aktualizuje pouze zadané
                                imported++;
                                batchCount++;

                                // Commit batch každých 400 položek (Firestore limit je 500)
                                if (batchCount >= 400) {
                                    await batch.commit();
                                    batch = db.batch();
                                    batchCount = 0;
                                }
                            } catch (err) {
                                errors++;
                                errorDetails.push(`Chyba při importu ${id}: ${err.message}`);
                            }
                        } else {
                            errors++;
                            errorDetails.push(`Neplatná data v řádku: ${line}`);
                        }
                    } else {
                        errors++;
                        errorDetails.push(`Nedostatek dat v řádku: ${line}`);
                    }
                }

                // Commit zbývající položky v batch
                if (batchCount > 0) {
                    await batch.commit();
                }

                let resultMessage = `<div class="text-green-600">✅ Import dokončen! Importováno: ${imported} produktů`;
                if (errors > 0) {
                    resultMessage += `<br><span class="text-yellow-600">⚠️ Chyby: ${errors}</span>`;
                    if (errorDetails.length > 0 && errorDetails.length <= 5) {
                        resultMessage += `<br><small class="text-gray-600">${errorDetails.join('<br>')}</small>`;
                    } else if (errorDetails.length > 5) {
                        resultMessage += `<br><small class="text-gray-600">První chyby: ${errorDetails.slice(0, 5).join('<br>')}...</small>`;
                    }
                }
                resultMessage += '</div>';
                
                resultDiv.innerHTML = resultMessage;
                await loadProducts(); // Znovu načíst produkty
                displayProductsAdmin(); // Aktualizovat zobrazení v admin panelu
            } catch (error) {
                resultDiv.innerHTML = `<div class="text-red-600">❌ Chyba: ${error.message}</div>`;
            }
        }

        // --- Admin: Billing Tab ---
        async function updateBilling() {
            const billingListDiv = document.getElementById('billingList');
            billingListDiv.innerHTML = '<p class="text-gray-600 p-4">Načítám data pro vyúčtování...</p>';
            const totalBillingAmountDiv = document.getElementById('totalBillingAmount');
            let globalTotal = 0;

            try {
                // Načti všechny aktivní objednávky
                const ordersSnapshot = await db.collection('orders').where('status', '==', 'active').get();
                // Seskup podle uživatele (použijeme email jako klíč)
                const usersBillingData = {};
                ordersSnapshot.forEach(orderDoc => {
                    const order = orderDoc.data();
                    // Klíčujeme podle emailu, pokud není, použijeme userId
                    const userKey = order.userEmail || order.userId;
                    // Robustní získání jména
                    const userName = order.userName || users[order.userEmail]?.name || users[order.userId]?.name || order.userEmail || order.userId || 'Neznámý uživatel';
                    const userEmail = order.userEmail || order.userId;
                    if (!usersBillingData[userKey]) {
                        usersBillingData[userKey] = {
                            userName: userName,
                            userEmail: userEmail,
                            totalAmount: 0, // Toto pole není přímo použito pro součet zde, ale může být užitečné pro budoucí rozšíření
                            orders: []
                        };
                    }
                    usersBillingData[userKey].orders.push({ ...order, id: orderDoc.id });
                });
                
                let html = '';
                if (Object.keys(usersBillingData).length === 0) {
                    html = '<p class="text-gray-600 p-4">Žádní uživatelé s aktivními objednávkami k vyúčtování.</p>';
                    totalBillingAmountDiv.innerText = '';
                } else {
                    for (const userKey in usersBillingData) {
                        const user = usersBillingData[userKey];
                        let userTotal = 0;
                        let userItemsHtml = '';
                        let hasUnpaidOrder = false; // Nová proměnná pro kontrolu nezaplacených objednávek

                        user.orders.forEach(order => {
                            let orderCurrentTotal = 0;
                            // Zkontrolujeme, zda existuje alespoň jedna nezaplacená objednávka
                            if (!order.paid) hasUnpaidOrder = true; 

                            userItemsHtml += `<div style="margin-bottom:5px;"><b>Objednávka ID: ${order.id.substring(0, 5)}...</b> (${order.paid ? 'Zaplaceno' : 'Nezaplaceno'}):<ul class="list-disc pl-5 text-sm">`;

                            Object.entries(order.items).forEach(([productId, quantity]) => {
                                const product = products[productId];
                                const productName = product ? product.name : `Neznámý produkt (ID: ${productId})`;
                                const itemPrice = product ? product.price : 0;
                                const itemTotal = itemPrice * quantity;
                                orderCurrentTotal += itemTotal;
                                userItemsHtml += `<li>${productName} x ${quantity} (${itemPrice} Kč/ks) = ${itemTotal} Kč</li>`;
                            });
                            userItemsHtml += `</ul><div class="font-bold text-right">Celkem objednávka: ${orderCurrentTotal} Kč</div></div>`;
                            userTotal += orderCurrentTotal;
                        });
                        globalTotal += userTotal;

                        const markPaidUnpaidButtons = user.orders.map(order => {
                            const currentPaidStatus = order.paid;
                            const orderIdShort = (order.id && typeof order.id === 'string') ? order.id.substring(0,5) : '';
                            const orderButtonText = currentPaidStatus ? 'Označit jako Nezaplaceno' : 'Označit jako Zaplaceno';
                            const orderButtonClass = currentPaidStatus ? 'bg-yellow-500' : 'bg-green-500';
                            return `<button onclick="togglePaymentStatus('${order.id}', ${!currentPaidStatus})" 
                                        class="${orderButtonClass} text-white px-3 py-1 rounded text-xs hover:opacity-80 ml-1 mt-1">
                                        ${orderButtonText} (ID: ${orderIdShort}...)
                                    </button>`;
                        }).join('');

                        html += `
                            <div class="bg-white p-4 rounded-lg shadow-md mb-4 border border-gray-200">
                                <h4 class="font-bold text-lg mb-2">${user.userName} (${user.userEmail})</h4>
                                <p class="font-bold text-md text-right mb-2">Celkem k úhradě aktivních objednávek: ${userTotal} Kč</p>
                                <p class="font-semibold mb-2">Detail aktivních objednávek:</p>
                                ${userItemsHtml}
                                <div class="mt-4 flex flex-wrap justify-end space-x-2 space-y-2">
                                    ${markPaidUnpaidButtons}
                                    <button onclick="showEmailPreview('${user.userEmail}')" class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600">Náhled emailu</button>
                                    <button onclick="generatePaymentQR('${user.userEmail}', ${userTotal}, '${user.userName}')" class="bg-purple-500 text-white px-3 py-1 rounded text-sm hover:bg-purple-600">QR Kód</button>
                                    <button onclick="sendSingleBillingEmailCloudFunction('${user.userEmail}', ${userTotal}, '${user.userName}')" 
                                            class="bg-green-700 text-white px-3 py-1 rounded text-sm hover:bg-green-800 ${!hasUnpaidOrder ? 'opacity-50 cursor-not-allowed' : ''}"
                                            ${!hasUnpaidOrder ? 'disabled' : ''}>
                                        Odeslat e-mail s vyúčtováním ${hasUnpaidOrder ? '' : '(vše zaplaceno)'}
                                    </button>
                                </div>
                                <div id="qrCodeContainer-${userKey.replace(/[^a-zA-Z0-9]/g, '-')}" class="mt-4 flex justify-center"></div>
                            </div>
                        `;
                    }
                    totalBillingAmountDiv.innerText = 'Celkem k úhradě: ' + globalTotal + ' Kč';
                }
                billingListDiv.innerHTML = html;
            } catch (error) {
                console.error("Chyba při načítání dat pro vyúčtování:", error);
                billingListDiv.innerHTML = '<p class="text-red-600 p-4">Chyba při načítání dat pro vyúčtování.</p>';
                totalBillingAmountDiv.innerText = '';
            }
        }
        
        // Funkce pro odeslání jednoho e-mailu s vyúčtováním přes Cloud Function
        async function sendSingleBillingEmailCloudFunction(userEmail, onlyUnpaid = false) {
            if (!userEmail) {
                alert('Chybí e-mail uživatele.');
                return;
            }
            if (onlyUnpaid && !confirm(`Opravdu chcete odeslat upozornění na platbu jen nezaplaceným uživatelům?`)) {
                return;
            }
            if (!onlyUnpaid && !confirm(`Opravdu chcete odeslat vyúčtování e-mailem uživateli: ${userEmail}?`)) {
                return;
            }

            const sendEmailStatusDiv = document.getElementById('sendEmailStatus');
            sendEmailStatusDiv.innerHTML = `<div class="text-blue-600">Odesílám e-mail uživateli ${userEmail}, prosím čekejte...</div>`;

            try {
                const sendBillingEmailCallable = functions.httpsCallable('sendBillingEmail');
                const result = await sendBillingEmailCallable({ userId: userEmail, onlyUnpaid: onlyUnpaid });

                if (result.data.success) {
                    sendEmailStatusDiv.innerHTML = `<div class="text-green-600">✅ E-mail pro uživatele ${userEmail} úspěšně odeslán: ${result.data.message}</div>`;
                    alert('E-mail odeslán!');
                } else {
                    sendEmailStatusDiv.innerHTML = `<div class="text-yellow-600">⚠️ E-mail pro uživatele ${userEmail} selhal: ${result.data.message}</div>`;
                    alert('E-mail selhal: ' + result.data.message);
                }
            } catch (error) {
                console.error(`Chyba při volání Cloud Function pro ${userEmail}:`, error);
                sendEmailStatusDiv.innerHTML = `<div class="text-red-600">❌ Chyba při odesílání e-mailu pro ${userEmail}: ${error.message || error}</div>`;
                alert('Chyba při odesílání e-mailu: ' + (error.message || error));
            }
        }

        // Funkce pro hromadné odeslání vyúčtování všem uživatelům s nezaplacenými objednávkami
        async function sendAllBillingEmails() {
            if (!confirm('Opravdu chcete odeslat upozornění na platbu všem uživatelům, kteří mají nezaplacené objednávky?')) {
                return;
            }

            const sendEmailStatusDiv = document.getElementById('sendEmailStatus');
            sendEmailStatusDiv.innerHTML = '<div class="text-blue-600">Odesílám e-maily, prosím čekejte...</div>';

            try {
                const ordersSnapshot = await db.collection('orders').where('status', '==', 'active').where('paid', '==', false).get();
                const usersWithUnpaidOrders = new Set();
                ordersSnapshot.forEach(doc => {
                    usersWithUnpaidOrders.add(doc.data().userId); 
                });

                if (usersWithUnpaidOrders.size === 0) {
                    sendEmailStatusDiv.innerHTML = '<div class="text-yellow-600">⚠️ Žádné nezaplacené aktivní objednávky k odeslání.</div>';
                    return;
                }

                let successfulSends = 0;
                let failedSends = 0;
                let messages = [];

                const sendBillingEmailCallable = functions.httpsCallable('sendBillingEmail');

                for (const userId of usersWithUnpaidOrders) {
                    try {
                        // Voláme Cloud Function s flagem onlyUnpaid=true
                        const result = await sendBillingEmailCallable({ userId: userId, onlyUnpaid: true });
                        if (result.data.success) {
                            successfulSends++;
                            messages.push(`✅ ${result.data.message}`);
                        } else {
                            failedSends++;
                            messages.push(`⚠️ ${result.data.message}`);
                        }
                    } catch (error) {
                        failedSends++;
                        messages.push(`❌ Chyba při odesílání e-mailu pro ${userId}: ${error.message}`);
                        console.error(`Chyba při volání Cloud Function pro ${userId}:`, error);
                    }
                }

                sendEmailStatusDiv.innerHTML = `
                    <div class="${failedSends > 0 ? 'text-red-600' : 'text-green-600'}">
                        Dokončeno. Úspěšně odesláno: ${successfulSends}, Selhalo: ${failedSends}
                        <div class="mt-2">${messages.join('<br>')}</div>
                    </div>
                `;
                 alert(`Odesílání dokončeno. Úspěšně odesláno: ${successfulSends}, Selhalo: ${failedSends}`);

            } catch (error) {
                console.error("Chyba při spouštění hromadného odesílání e-mailů:", error);
                sendEmailStatusDiv.innerHTML = `<div class="text-red-600">❌ Chyba při spouštění odesílání: ${error.message}</div>`;
            }
        }

        // --- Email Preview for Billing ---
        async function showEmailPreview(userEmail) {
            const user = users[userEmail];
            const userName = user ? user.name : userEmail;
            if (!user) {
                alert('Uživatel nenalezen.');
                return;
            }
            // Načteme všechny aktivní objednávky pro daného uživatele
            const ordersSnapshot = await db.collection('orders')
                .where('userId', '==', userEmail)
                .where('status', '==', 'active')
                .get();
            if (ordersSnapshot.empty) {
                alert(`Pro uživatele ${userName} (${userEmail}) nejsou žádné aktivní objednávky.`);
                return;
            }
            let totalForUser = 0;
            let itemsHtmlForEmail = '';
            const productsSnapshot = await db.collection('products').get();
            const allProductsMap = {};
            productsSnapshot.forEach(doc => { allProductsMap[doc.id] = doc.data(); });
            ordersSnapshot.forEach(orderDoc => {
                const order = orderDoc.data();
                let orderCurrentTotal = 0;
                let orderPaidStatus = order.paid ? 'Zaplaceno' : 'Nezaplaceno';
                itemsHtmlForEmail += `<div style="margin-bottom:10px;"><b>Tvoje objednávka</b> (${orderPaidStatus}):<ul style="list-style-type: disc; margin-left: 20px;">`;
                Object.entries(order.items).forEach(([productId, quantity]) => {
                    const product = allProductsMap[productId];
                    const productName = product ? product.name : `Neznámý produkt (ID: ${productId})`;
                    const itemPrice = product ? product.price : 0;
                    const itemTotal = itemPrice * quantity;
                    orderCurrentTotal += itemTotal;
                    itemsHtmlForEmail += `<li style="font-size: 0.95em;">${productName} x ${quantity} (${itemPrice} Kč/ks) = ${itemTotal} Kč</li>`;
                });
                itemsHtmlForEmail += `</ul><div style="font-weight: bold; text-align: right;">Celkem objednávka: ${orderCurrentTotal} Kč</div></div>`;
                totalForUser += orderCurrentTotal;
            });
            const emailContent = `
                <p>Ahoj,</p>
                <p>zde je shrnutí tvých aktivních objednávek k úhradě:</p>
                <div style="margin-top: 15px; margin-bottom: 20px; border: 1px solid #ddd; padding: 10px;">
                    ${itemsHtmlForEmail}
                </div>
                <p style="font-weight: bold; font-size: 1.1em; text-align: right;">Celkem k úhradě: ${totalForUser} Kč</p>
                <p>Pro platbu prosím použij bankovní převod na účet: <strong>219731465/0300</strong> ve výši <strong>${totalForUser} Kč</strong>.</p>
                <p style="margin-top: 20px;">Děkujeme za objednávku!</p>
                <p>S pozdravem,<br>Lukáš Vladyka</p>
            `;
            const previewWindow = window.open('', '_blank', 'width=700,height=800,scrollbars=yes');
            previewWindow.document.write('<html><head><title>Náhled e-mailu pro ' + userName + '</title></head><body>');
            previewWindow.document.write(emailContent);
            previewWindow.document.write('</body></html>');
            previewWindow.document.close();
        }

        // --- Utility Functions ---
        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        async function resetAllOrders() {
            if (!confirm('Opravdu chcete smazat všechny aktivní objednávky (přesunout do archivu)?')) return;
            await loadProducts(); // Zajistí, že produkty jsou aktuální
            const batch = db.batch();
            const snapshot = await db.collection('orders').where('status', '==', 'active').get();
            snapshot.forEach(doc => {
                batch.update(doc.ref, { status: 'archived' });
            });
            await batch.commit();
            alert('Všechny aktivní objednávky byly archivovány.');
            await loadOrders(); // Znovu načíst objednávky, aby se správně propsaly produkty
        }

        // --- Firebase a Data Loading ---
        async function loadUsers() {
            try {
                const snapshot = await db.collection('users').get();
                users = {};
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data && data.name) {
                        users[doc.id] = { id: doc.id, ...data };
                    } else {
                        console.warn('Uživatel bez jména nebo dat:', doc.id, data);
                    }
                });
                if (document.getElementById('userSearch').value.length > 0) {
                    searchUsers();
                }
            } catch (e) {
                console.error('Chyba při načítání uživatelů:', e);
            }
        }
        window.loadUsers = loadUsers;

        async function loadProducts() {
            try {
                const snapshot = await db.collection('products').get();
                products = {};
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data && data.name) {
                        products[doc.id] = { id: doc.id, ...data };
                    } else {
                        console.warn('Produkt bez jména nebo dat:', doc.id, data);
                    }
                });
            } catch (e) {
                console.error('Chyba při načítání produktů:', e);
            }
        }
        window.loadProducts = loadProducts;

        // --- User Selection (Main Screen) ---
        function searchUsers() {
            const query = document.getElementById('userSearch').value.toLowerCase();
            const resultsDiv = document.getElementById('userSearchResults');
            if (query.length < 2) {
                resultsDiv.classList.add('hidden');
                return;
            }
            const results = Object.entries(users).filter(([email, user]) => 
                user.name && user.name.toLowerCase().includes(query)
            ).slice(0, 10);
            if (results.length === 0) {
                resultsDiv.innerHTML = `
                    <div class="p-4 text-center">
                        <p class="text-gray-600 mb-2">Uživatel nenalezen</p>
                        <button onclick="addNewUser('${query}')" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                            Přidat nového uživatele
                        </button>
                    </div>
                `;
                resultsDiv.classList.remove('hidden');
                return;
            }
            resultsDiv.innerHTML = results.map(([email, user]) => `
                <div onclick="selectUser('${email}')" class="p-3 hover:bg-gray-100 cursor-pointer border-b">
                    <div class="font-semibold">${user.name}</div>
                </div>
            `).join('');
            resultsDiv.classList.remove('hidden');
        }

        // --- Přidání nového uživatele z hlavní obrazovky ---
        async function addNewUser(query) {
            const name = prompt('Zadejte jméno nového uživatele:', query.charAt(0).toUpperCase() + query.slice(1));
            if (!name || name.length < 2) {
                alert('Neplatné jméno.');
                return;
            }
            const email = prompt('Zadejte e-mail nového uživatele:');
            if (!email || !email.includes('@')) {
                alert('Neplatný e-mail.');
                return;
            }
            try {
                await db.collection('users').doc(email).set({
                    name: name,
                    email: email
                });
                await loadUsers();
                alert('Uživatel přidán!');
                document.getElementById('userSearch').value = name;
                searchUsers();
            } catch (err) {
                alert('Chyba při přidávání uživatele: ' + err.message);
            }
        }
        window.addNewUser = addNewUser;

        // --- Nastavení termínu objednávek ---
        async function setOrderingDeadline() {
            const deadlineInput = document.getElementById('orderingDeadline');
            const value = deadlineInput.value;
            if (!value) {
                alert('Zadejte termín.');
                return;
            }
            try {
                await db.collection('settings').doc('ordering').set({ deadline: value });
                alert('Termín uložen!');
            } catch (err) {
                alert('Chyba při ukládání termínu: ' + err.message);
            }
        }
        window.setOrderingDeadline = setOrderingDeadline;

        // --- QR generátor ---
        function generatePaymentQR(userEmail, amount, userName) {
            // IBAN a další údaje pouze pro QR, ne do mailu
            const iban = 'CZ6703000000000219731465';
            const account = '219731465/0300';
            const message = encodeURIComponent(`Platba objednávky pro ${userName}`);
            const qrData = `SPD*1.0*ACC:${iban}*AM:${amount}*CC:CZK*MSG:${message}`;
            const qrContainerId = `qrCodeContainer-${userEmail.replace(/[^a-zA-Z0-9]/g, '-')}`;
            const qrContainer = document.getElementById(qrContainerId);
            qrContainer.innerHTML = '';
            new QRCode(qrContainer, {
                text: qrData,
                width: 180,
                height: 180
            });
        }
        window.generatePaymentQR = generatePaymentQR;

        // --- Oprava funkce změny hesla ---
        async function changeAdminPassword() {
            const newPassword = document.getElementById('adminNewPassword').value;
            if (!newPassword || newPassword.length < 4) {
                alert('Zadejte nové heslo (alespoň 4 znaky).');
                return;
            }
            localStorage.setItem(ADMIN_PASSWORD_KEY, newPassword);
            document.getElementById('adminNewPassword').value = '';
            document.getElementById('passwordChangeStatus').innerText = 'Heslo změněno!';
        }
        window.changeAdminPassword = changeAdminPassword;

        // --- Zajistím načtení uživatelů a produktů hned po načtení stránky ---
        document.addEventListener('DOMContentLoaded', () => {
            loadUsers();
            loadProducts(); // přidáno, aby produkty byly vždy dostupné
        });

        // --- Opravím, aby selectUser byla dostupná v globálním scope ---
        function selectUser(email) {
            // Původní logika výběru uživatele
            const user = users[email];
            if (!user) {
                alert('Uživatel nenalezen.');
                return;
            }
            currentUser = user;
            document.getElementById('selectedUserName').innerText = user.name;
            document.getElementById('selectedUser').classList.remove('hidden');
            document.getElementById('userSearchResults').classList.add('hidden');
            document.getElementById('userSearch').value = user.name;
            document.getElementById('productSection').classList.remove('hidden');
            document.getElementById('orderSection').classList.remove('hidden');
            renderCurrentUserOrder(); // přidáno
        }
        window.selectUser = selectUser;

        // --- searchProducts pro vyhledávání produktů (a zpřístupnění v globálním scope) ---
        function searchProducts() {
            const query = document.getElementById('productSearch').value.toLowerCase();
            const resultsDiv = document.getElementById('productSearchResults');
            if (query.length < 2) {
                resultsDiv.classList.add('hidden');
                return;
            }
            const results = Object.values(products).filter(product =>
                product.name.toLowerCase().includes(query) ||
                (product.id && product.id.toLowerCase().includes(query))
            ).slice(0, 10);
            if (results.length === 0) {
                resultsDiv.innerHTML = `<div class="p-4 text-center"><p class="text-gray-600 mb-2">Produkt nenalezen</p></div>`;
                resultsDiv.classList.remove('hidden');
                return;
            }
            resultsDiv.innerHTML = results.map(product => `
                <div onclick="selectProduct('${product.id}')" class="p-3 hover:bg-gray-100 cursor-pointer border-b">
                    <div class="font-semibold">${product.name} (${product.id})</div>
                    <div class="text-sm text-gray-500">${product.price} Kč</div>
                </div>
            `).join('');
            resultsDiv.classList.remove('hidden');
        }
        window.searchProducts = searchProducts;

        // --- selectProduct pro výběr produktu (zpřístupnění v globálním scope) ---
        function selectProduct(productId) {
            const product = products[productId];
            if (!product) return;
            document.getElementById('selectedProductName').innerText = product.name;
            document.getElementById('selectedProductId').value = product.id;
            document.getElementById('manualProductAdd').classList.remove('hidden');
        }
        window.selectProduct = selectProduct;

        // --- Přidání produktu do objednávky (zpřístupnění v globálním scope) ---
        function addProductToOrderManual() {
            if (!currentUser) {
                alert('Nejprve vyberte uživatele.');
                return;
            }
            const productId = document.getElementById('selectedProductId').value;
            const quantity = parseInt(document.getElementById('productQuantityInput').value);
            if (!productId || !products[productId]) {
                alert('Vyberte platný produkt.');
                return;
            }
            if (!quantity || quantity < 1) {
                alert('Zadejte platné množství.');
                return;
            }
            db.collection('orders')
              .where('userId', '==', currentUser.id || currentUser.email)
              .where('status', '==', 'active')
              .limit(1)
              .get()
              .then(snapshot => {
                if (!snapshot.empty) {
                  const orderRef = snapshot.docs[0].ref;
                  const orderData = snapshot.docs[0].data();
                  orderData.items = orderData.items || {};
                  orderData.items[productId] = quantity;
                  let total = 0;
                  Object.entries(orderData.items).forEach(([pid, qty]) => {
                    const prod = products[pid];
                    if (prod) total += prod.price * qty;
                  });
                  orderData.totalPrice = total;
                  return orderRef.update({ items: orderData.items, totalPrice: total });
                } else {
                  const items = {};
                  items[productId] = quantity;
                  let total = products[productId].price * quantity;
                  return db.collection('orders').add({
                    userId: currentUser.id || currentUser.email,
                    userName: currentUser.name,
                    userEmail: currentUser.email,
                    items: items,
                    totalPrice: total,
                    paid: false,
                    status: 'active',
                    timestamp: new Date()
                  });
                }
              })
              .then(() => {
                alert('Produkt přidán/aktualizován v objednávce!');
                loadOrders && loadOrders();
                updateBilling && updateBilling();
                renderCurrentUserOrder(); // přidáno
              })
              .catch(err => {
                alert('Chyba při přidávání produktu do objednávky: ' + err.message);
              });
        }
        window.addProductToOrderManual = addProductToOrderManual;

        // --- Zobrazení aktivní objednávky aktuálního uživatele na hlavní stránce ---
        async function renderCurrentUserOrder() {
            if (!currentUser) {
                document.getElementById('orderItems').innerHTML = '';
                document.getElementById('totalPrice').innerText = '0 Kč';
                return;
            }
            // Najdi aktivní objednávku pro aktuálního uživatele
            const snapshot = await db.collection('orders')
                .where('userId', '==', currentUser.id || currentUser.email)
                .where('status', '==', 'active')
                .limit(1)
                .get();
            if (snapshot.empty) {
                document.getElementById('orderItems').innerHTML = '';
                document.getElementById('totalPrice').innerText = '0 Kč';
                return;
            }
            const order = snapshot.docs[0].data();
            let html = '';
            let total = 0;
            Object.entries(order.items).forEach(([productId, quantity]) => {
                const product = products[productId];
                if (!product) return;
                const itemTotal = product.price * quantity;
                total += itemTotal;
                html += `<tr><td class='p-2'>${product.name}</td><td class='text-center p-2'>${quantity}</td><td class='text-right p-2'>${product.price} Kč</td><td class='text-right p-2'>${itemTotal} Kč</td><td class='text-center p-2'><button onclick="removeProductFromOrder('${productId}')" title='Odebrat produkt' class='text-red-600 hover:text-red-800'><svg xmlns='http://www.w3.org/2000/svg' class='inline w-5 h-5' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M6 18L18 6M6 6l12 12'/></svg></button></td></tr>`;
            });
            document.getElementById('orderItems').innerHTML = html;
            document.getElementById('totalPrice').innerText = total + ' Kč';
        }
        window.renderCurrentUserOrder = renderCurrentUserOrder;

        // --- Odebrání produktu z objednávky na hlavní stránce ---
        async function removeProductFromOrder(productId) {
            if (!currentUser) {
                alert('Nejprve vyberte uživatele.');
                return;
            }
            // Najdi aktivní objednávku pro aktuálního uživatele
            const snapshot = await db.collection('orders')
                .where('userId', '==', currentUser.id || currentUser.email)
                .where('status', '==', 'active')
                .limit(1)
                .get();
            if (snapshot.empty) {
                alert('Objednávka nenalezena.');
                return;
            }
            const orderRef = snapshot.docs[0].ref;
            const orderData = snapshot.docs[0].data();
            if (!orderData.items || !orderData.items[productId]) return;
            delete orderData.items[productId];
            // Přepočítat celkovou cenu
            let total = 0;
            Object.entries(orderData.items).forEach(([pid, qty]) => {
                const prod = products[pid];
                if (prod) total += prod.price * qty;
            });
            orderData.totalPrice = total;
            // Pokud už není žádný produkt, můžeš objednávku smazat nebo nechat prázdnou
            if (Object.keys(orderData.items).length === 0) {
                await orderRef.delete();
            } else {
                await orderRef.update({ items: orderData.items, totalPrice: total });
            }
            renderCurrentUserOrder();
            loadOrders && loadOrders();
            updateBilling && updateBilling();
        }
        window.removeProductFromOrder = removeProductFromOrder;
    </script>
</body>
</html>